(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{155:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return s})),a.d(t,"metadata",(function(){return l})),a.d(t,"rightToc",(function(){return o})),a.d(t,"default",(function(){return p}));var n=a(2),r=a(11),i=(a(0),a(241)),s={id:"twilio-app-tutorial",title:"Twilio tutorial",sidebar_label:"Twilio tutorial"},l={id:"tutorials/twilio-app-tutorial",isDocsHomePage:!1,title:"Twilio tutorial",description:"Dark allows you to build backends (API endpoints, workers, cron, and data storage) by writing only your business logic, using production traces.",source:"@site/docs/tutorials/twilio-app-tutorial.md",permalink:"/docs/tutorials/twilio-app-tutorial",sidebar_label:"Twilio tutorial",sidebar:"Tutorials",previous:{title:"React SPA tutorial",permalink:"/docs/tutorials/react-spa-tutorial"},next:{title:"Clean Error Messages with the Error Rail",permalink:"/docs/tutorials/error-rail-http-tutorial"}},o=[{value:"Daily Text Reminder App",id:"daily-text-reminder-app",children:[{value:"Twilio Credentials",id:"twilio-credentials",children:[]},{value:"Sending a Message",id:"sending-a-message",children:[]},{value:"Receiving Responses",id:"receiving-responses",children:[]},{value:"Processing &amp; Storing Responses",id:"processing--storing-responses",children:[]},{value:"Sign up &amp; Quit",id:"sign-up--quit",children:[]},{value:"Water Tracking",id:"water-tracking",children:[]},{value:"Catch-all Case",id:"catch-all-case",children:[]},{value:"Sending Reminder Messages Once A Day",id:"sending-reminder-messages-once-a-day",children:[]},{value:"Additional Topics (for Fun!)",id:"additional-topics-for-fun",children:[]}]}],c={rightToc:o};function p(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},c,a,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"Dark allows you to build backends (API endpoints, workers, cron, and data storage) by writing only your business logic, using production traces."),Object(i.b)("p",null,"You can access you canvas at darklang.com/a/USERNAME (or USERNAME-CANVASNAME). For this project we recommend darklang.com/a/USERNAME-twilioreminder."),Object(i.b)("p",null,"We recommend building a hello world API endpoint to get a feel for Dark, as follows:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image2.gif",alt:"assets/twilio/image2.gif"}))),Object(i.b)("p",null,"All the major handlers work the same way, but the key for many requests is working directly with incoming data."),Object(i.b)("h2",{id:"daily-text-reminder-app"},"Daily Text Reminder App"),Object(i.b)("p",null,"We\u2019re building this app: ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://sample-textreminder.builtwithdark.com/"}),"https://sample-textreminder.builtwithdark.com"),"\nIt\u2019s an app that will send a text message once per day at a given time to an end user. In this case, we\u2019ll ask the user \u201cdid you drink enough water today?\u201d and track their response."),Object(i.b)("p",null,"To try out the app and see your traces in the sample canvas text \u201cstart\u201d to +12482653257."),Object(i.b)("h3",{id:"twilio-credentials"},"Twilio Credentials"),Object(i.b)("p",null,"To build your own, you\u2019ll need to set up a Twilio account. Your Twilio SID & Token are on the Dashboard."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image16.png",alt:"assets/twilio/mage16.png"}))),Object(i.b)("p",null,"You\u2019ll also need to add a phone number from the \u201cmore\u201d menu on the left-hand side, then to the phone number section."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image15.png",alt:"assets/twilio/image15.png"}))),Object(i.b)("p",null,"Once you\u2019ve added a phone number, you can configure a webhook:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image17.png",alt:"assets/twilio/image17.png"}))),Object(i.b)("h3",{id:"sending-a-message"},"Sending a Message"),Object(i.b)("p",null,"Dark has a built in ",Object(i.b)("inlineCode",{parentName:"p"},"Twilio::sendText")," function. We can call it in a REPL with our own number to verify our webhook."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image4.png",alt:"assets/twilio/mage4.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=1108947374"}),"https://darklang.com/a/sample-textreminder#handler=1108947374")),Object(i.b)("h3",{id:"receiving-responses"},"Receiving Responses"),Object(i.b)("p",null,"After we receive a response, we\u2019ll see a 404 in the side bar section for our webhook, which we can create by hitting the \u201c+\u201d button."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image3.png",alt:"assets/twilio/mage3.png"}))),Object(i.b)("p",null,"Once the handler is created, we\u2019re able to see the full incoming trace."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image19.png",alt:"assets/twilio/image19.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=1004312353"}),"https://darklang.com/a/sample-textreminder#handler=1004312353")),Object(i.b)("h3",{id:"processing--storing-responses"},"Processing & Storing Responses"),Object(i.b)("p",null,"In Dark, you can work directly with incoming traces. More on this in ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/trace-driven-development"}),"Trace Driven Development"),". For this handler, we can parse out the things we care about: a user deciding to start/stop using our service, or telling us if they drank enough water or not."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image7.png",alt:"assets/twilio/image7.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=1004312353"}),"https://darklang.com/a/sample-textreminder#handler=1004312353")),Object(i.b)("p",null,"At each expression, we can see what the expression evaluates to for a given trace. Here, we see the From number. In this case we also do some cleaning on the response in case the user had a capital letter or an extraneous space."),Object(i.b)("p",null,"For processing the various responses, we\u2019ll use a match statement. More on ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/docs/functional-aspects#match"}),"Match")," is available, but the tutorial example has enough context to understand how it works for this case."),Object(i.b)("h3",{id:"sign-up--quit"},"Sign up & Quit"),Object(i.b)("p",null,"Now, let\u2019s do the \u201cstart\u201d case. This allows us to give the user our Twilio number, and have them text \u201cstart\u201d to begin receiving a daily reminder. We\u2019ll need a data store to keep track of our users, which can be created from the omnibox (",Object(i.b)("inlineCode",{parentName:"p"},"Cmd/Ctrl-k"),") or the side bar."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image1.png",alt:"assets/twilio/image1.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#db=973891964"}),"https://darklang.com/a/sample-textreminder#db=973891964")),Object(i.b)("p",null,"Then, we can write the logic to add users to the datastore when they text \u201cstart.\u201d In this case we use the user\u2019s phone number as the unique key."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image9.png",alt:"assets/twilio/image9.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=1004312353"}),"https://darklang.com/a/sample-textreminder#handler=1004312353")),Object(i.b)("p",null,"The stop case is very similar, but removes the user from the datastore."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image13.png",alt:"assets/twilio/image13.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=1004312353"}),"https://darklang.com/a/sample-textreminder#handler=1004312353")),Object(i.b)("p",null,"To test, you can always send a new reply to the text message (or just message your number) and walk through the trace to see the live values at each step."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image11.png",alt:"assets/twilio/image11.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=1004312353"}),"https://darklang.com/a/sample-textreminder#handler=1004312353")),Object(i.b)("h3",{id:"water-tracking"},"Water Tracking"),Object(i.b)("p",null,"Now we\u2019ll want the cases for when the user responds to the daily question of \u201cdid you drink enough water today?\u201d"),Object(i.b)("p",null,"We\u2019ll want another data store so we can track the daily response by user (side bar or ",Object(i.b)("inlineCode",{parentName:"p"},"Cmd/Ctrl-k"),")."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image12.png",alt:"assets/twilio/image12.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#db=1164294845"}),"https://darklang.com/a/sample-textreminder#db=1164294845")),Object(i.b)("p",null,"In this case since we do not want to use the phone number as the unique key, we generate a unique key when storing using the built in ",Object(i.b)("inlineCode",{parentName:"p"},"DB::generateKey")," function:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image18.png",alt:"assets/twilio/image18.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=1004312353"}),"https://darklang.com/a/sample-textreminder#handler=1004312353")),Object(i.b)("h3",{id:"catch-all-case"},"Catch-all Case"),Object(i.b)("p",null,"Finally, we need a case for when we don\u2019t match on one of our earlier responses. We\u2019ll want to send a text back to tell the user about the error. To prevent this from blocking other actions, we\u2019ll emit to a background worker."),Object(i.b)("p",null,"Here, we emit the user\u2019s number (user) to a background worker named Misunderstood (and see the event as a trace). Once you\u2019ve hit \u201cplay\u201d on the emit expression, you should have a 404 for the worker in the side bar that you can hit the + to add. If it does not appear in the sidebar, wait ","~","30s or refresh the browser."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image14.png",alt:"assets/twilio/image14.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=331438030"}),"https://darklang.com/a/sample-textreminder#handler=331438030")),Object(i.b)("p",null,"Then we can write the code similar to our earlier REPL to send a message asking for a more clear response:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image8.png",alt:"assets/twilio/image8.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=331438030"}),"https://darklang.com/a/sample-textreminder#handler=331438030")),Object(i.b)("h3",{id:"sending-reminder-messages-once-a-day"},"Sending Reminder Messages Once A Day"),Object(i.b)("p",null,"To send each user a reminder once per day, we\u2019ll want to have a cron set to run daily. In this case we\u2019ll get all the users, then emit to a background worker to send the messages."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image6.png",alt:"assets/twilio/image6.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=1621731316"}),"https://darklang.com/a/sample-textreminder#handler=1621731316")),Object(i.b)("p",null,"Much like before, this will add the worker to the 404 section where you can add it, with the traces."),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image5.png",alt:"assets/twilio/image5.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=337743491"}),"https://darklang.com/a/sample-textreminder#handler=337743491")),Object(i.b)("p",null,"The code is identical to the code in our REPL:"),Object(i.b)("p",null,Object(i.b)("img",Object(n.a)({parentName:"p"},{src:"assets/twilio/image10.png",alt:"assets/twilio/image10.png"}))),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=337743491"}),"https://darklang.com/a/sample-textreminder#handler=337743491")),Object(i.b)("p",null,"This is now a fully functioning application."),Object(i.b)("p",null,"You could do similar ones for:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"A reminder to stand up once per hour"),Object(i.b)("li",{parentName:"ul"},"A daily reminder to do a task (fill in a personal CRM, floss)"),Object(i.b)("li",{parentName:"ul"},"A weekly reminder to take out the trash")),Object(i.b)("h3",{id:"additional-topics-for-fun"},"Additional Topics (for Fun!)"),Object(i.b)("h4",{id:"cron-at-time-of-day"},"Cron at Time of Day"),Object(i.b)("p",null,"If you\u2019d like to set the reminder to occur at a specific time of day, you can set this using a datastore. There\u2019s a sample canvas ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-setcrontorunatspecifictime"}),"here"),". For this application, add the \u201creminder time\u201d in the ",Object(i.b)("inlineCode",{parentName:"p"},"Users")," table, and add a case to allow users to specify a time (that you would then convert to a Date object)."),Object(i.b)("h4",{id:"seeingdisplaying-responses"},"Seeing/Displaying Responses"),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=911581692"}),"This API handler shows all checkins for a given user.")),Object(i.b)("p",null,Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"https://darklang.com/a/sample-textreminder#handler=400638438"}),"This API handler shows the percentage of \u201cyes\u201d responses for a given user.")))}p.isMDXComponent=!0},241:function(e,t,a){"use strict";a.d(t,"a",(function(){return b})),a.d(t,"b",(function(){return u}));var n=a(0),r=a.n(n);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var c=r.a.createContext({}),p=function(e){var t=r.a.useContext(c),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},b=function(e){var t=p(e.components);return r.a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},m=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),b=p(a),m=n,u=b["".concat(s,".").concat(m)]||b[m]||d[m]||i;return a?r.a.createElement(u,l(l({ref:t},c),{},{components:a})):r.a.createElement(u,l({ref:t},c))}));function u(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,s=new Array(i);s[0]=m;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l.mdxType="string"==typeof e?e:n,s[1]=l;for(var c=2;c<i;c++)s[c]=a[c];return r.a.createElement.apply(null,s)}return r.a.createElement.apply(null,a)}m.displayName="MDXCreateElement"}}]);