(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{166:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return l})),n.d(t,"metadata",(function(){return o})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return b}));var a=n(2),r=n(11),i=(n(0),n(241)),l={id:"datastores",title:"Datastores",sidebar_label:"Datastores"},o={id:"datastores",isDocsHomePage:!1,title:"Datastores",description:"Overview",source:"@site/docs/datastores.md",permalink:"/docs/datastores",sidebar_label:"Datastores",sidebar:"docs",previous:{title:"Language Details",permalink:"/docs/languagedetails"},next:{title:"Packages",permalink:"/docs/packages"}},c=[{value:"Overview",id:"overview",children:[{value:"Keys",id:"keys",children:[]},{value:"Values",id:"values",children:[]}]},{value:"DB Functions",id:"db-functions",children:[{value:"Adding a record to a Datastore",id:"adding-a-record-to-a-datastore",children:[]},{value:"Datastore meta-actions",id:"datastore-meta-actions",children:[]},{value:"Querying by key, <code>DB::get</code>",id:"querying-by-key-dbget",children:[]},{value:"Querying by record field, <code>DB::queryExactField</code>",id:"querying-by-record-field-dbqueryexactfield",children:[]},{value:"Querying by criteria, <code>DB::query</code> (experimental SQL Compiler)",id:"querying-by-criteria-dbquery-experimental-sql-compiler",children:[]},{value:"Creating References Between DBs",id:"creating-references-between-dbs",children:[]}]},{value:"Migrations, Locking, and Unlocking",id:"migrations-locking-and-unlocking",children:[]},{value:"Using an External Datastore",id:"using-an-external-datastore",children:[]}],s={rightToc:c};function b(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h2",{id:"overview"},"Overview"),Object(i.b)("p",null,"Datastores in Dark are key-value based (persistent hash-maps). When you create a\nnew datastore, you specify the schema for the record."),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/docs/img/datastores/empty.png",alt:"Empty Datastore"}))),Object(i.b)("p",null,"The key is the unique identifier for each record, and is always of type\n",Object(i.b)("inlineCode",{parentName:"p"},"string"),". ",Object(i.b)("strong",{parentName:"p"},"The key is not visible when looking at the Datastore's schema on the\ncanvas.")," You cannot mark a record field as the key, but you can use the same\nvalue for the field and the key when using ",Object(i.b)("inlineCode",{parentName:"p"},"Db::set"),". An expected response when\nretrieving a set of records, with keys, is as following:"),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"[{key: { key1: value1, key2: value2} }, {key: { key1: value3, key2: value4}]")),Object(i.b)("p",null,"You query datastores in four ways:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"By key (",Object(i.b)("inlineCode",{parentName:"li"},"DB::get")," family)"),Object(i.b)("li",{parentName:"ul"},"By specific field (",Object(i.b)("inlineCode",{parentName:"li"},"DB::queryExactField")," family)"),Object(i.b)("li",{parentName:"ul"},"By criteria for a specific field (",Object(i.b)("inlineCode",{parentName:"li"},"DB::query")," family)"),Object(i.b)("li",{parentName:"ul"},"By gathering information about the entire datastore")),Object(i.b)("p",null,"Datastores return one or many results, with or without keys."),Object(i.b)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/_LqlHR55GZQ",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0}),Object(i.b)("h3",{id:"keys"},"Keys"),Object(i.b)("p",null,"The schema is the same for all of these key examples:"),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/docs/img/datastores/schema.png",alt:"Datastore Schema"}))),Object(i.b)("p",null,"Some common key choices:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"A unique field (like ",Object(i.b)("inlineCode",{parentName:"li"},"userId"),"). If the field is not already a string use\n",Object(i.b)("inlineCode",{parentName:"li"},"toString"),". The key is shown in the preview data.")),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},'[{"1": { userId: 1, name: "Ellen", pets: ["Gutenberg"]} }, {"2": { userId: 2, name: "Paul", pets: []}]')),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"A unique derivative of a field (like name and ",Object(i.b)("inlineCode",{parentName:"li"},"UserId"),", or a slug).")),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},'[{"ellen1": { userId: 1, name: "Ellen", pets: ["Gutenberg"]} }, {"paul2": { userId: 2, name: "Paul", pets: []}]')),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"A unique identifier generated programmatically (",Object(i.b)("inlineCode",{parentName:"li"},"DB::generateKey"),").")),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},'[{"dee09c7e-6ede-402d-9ea4-4ee8fe843688": { id: 1, name: "Ellen", pets: ["Gutenberg"]} }, {"ac7d4f1f-a164-4450-96f3-728b087bb9f4": { id: 2, name: "Paul", pets: []}]')),Object(i.b)("h3",{id:"values"},"Values"),Object(i.b)("p",null,"The datastore holds records. In the future, datastores will be defined by type,\nbut for now you manually create the schema. Available types are: String, Int,\nBool, Float, Password, Date, UUID, Dict (and lists of those)."),Object(i.b)("h2",{id:"db-functions"},"DB Functions"),Object(i.b)("p",null,"Datastore operators are built into the language. All functions are independently\nversioned. In your canvas you will see the latest version, as well as any\nversions you are currently using."),Object(i.b)("p",null,"A list of all datastore functions is available\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://ops-documentation.builtwithdark.com/?pretty=1"}),"in the language reference"),"."),Object(i.b)("h3",{id:"adding-a-record-to-a-datastore"},"Adding a record to a Datastore"),Object(i.b)("p",null,"To add items into a datastore, use ",Object(i.b)("inlineCode",{parentName:"p"},"DB::set"),". ",Object(i.b)("inlineCode",{parentName:"p"},"DB::set")," takes three parameters\n(the record to be added, its unique key, and the datastore)."),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/docs/img/datastores/dbset_empty.png",alt:"DBset"}))),Object(i.b)("p",null,"For the earlier example datastore, using this with ",Object(i.b)("inlineCode",{parentName:"p"},"userID")," as the key would\nlook as follows:"),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/docs/img/datastores/dbset.png",alt:"DBset"}))),Object(i.b)("p",null,"Using the a generated key with ",Object(i.b)("inlineCode",{parentName:"p"},"DB::generateKey")," would look like this instead:"),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/docs/img/datastores/dbset_genkey.png",alt:"DBset"}))),Object(i.b)("h3",{id:"datastore-meta-actions"},"Datastore meta-actions"),Object(i.b)("p",null,"Some datastore functions provide ability to do something to the entire\ndatastore, and only require the datastore as the parameter."),Object(i.b)("p",null,"Any datastore function that includes 'with keys' returns both the key and the\nvalue, a list of nested dictionaries\n",Object(i.b)("inlineCode",{parentName:"p"},'[{"1": { userId: 1, name: "Ellen", pets: ["Gutenberg"]} }, {"2": { userId: 2, name: "Paul", pets: []}]')),Object(i.b)("p",null,"Functions that do not include 'with keys' return just the values, a list of\ndictionaries\n",Object(i.b)("inlineCode",{parentName:"p"},'[{ userId: 1, name: "Ellen", pets: ["Gutenberg"]} , {userId: 2, name: "Paul", pets: []}]')),Object(i.b)("p",null,"These include:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::count")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::deleteAll")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::getAll")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::getAllwithKeys")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::keys")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::schemaFields")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::schema"))),Object(i.b)("p",null,"To easily see is in your Datastore, create a REPL and running ",Object(i.b)("inlineCode",{parentName:"p"},"DB::getAll"),"."),Object(i.b)("h3",{id:"querying-by-key-dbget"},"Querying by key, ",Object(i.b)("inlineCode",{parentName:"h3"},"DB::get")),Object(i.b)("p",null,"The key is a good way to be able to find information in the datastore. DB::get\nfinds records by key (reminder: ",Object(i.b)("inlineCode",{parentName:"p"},"withKeys")," returns nested dictionaries including\nkeys, so ",Object(i.b)("inlineCode",{parentName:"p"},"DB::get")," does not return the key). Datastore functions that allow\naction based on key are:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::delete")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::get")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::getMany")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::getManywithKeys"))),Object(i.b)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/qNA8FzGkdWI",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0}),Object(i.b)("h3",{id:"querying-by-record-field-dbqueryexactfield"},"Querying by record field, ",Object(i.b)("inlineCode",{parentName:"h3"},"DB::queryExactField")),Object(i.b)("p",null,"Using ",Object(i.b)("inlineCode",{parentName:"p"},"DB::queryExactField")," checks for a specific field within the record.\n",Object(i.b)("inlineCode",{parentName:"p"},"DB::queryOnewithExactField")," finds one response, whereas ",Object(i.b)("inlineCode",{parentName:"p"},"DB::queryExactFields"),"\nwill return as many as exist. (reminder: ",Object(i.b)("inlineCode",{parentName:"p"},"withKeys")," returns nested dictionaries\nincluding keys)."),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::queryExactFields")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::queryExactFieldswithKey")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::queryOnewithExactField")),Object(i.b)("li",{parentName:"ul"},Object(i.b)("inlineCode",{parentName:"li"},"DB::queryOneWithExactFieldWithKey"))),Object(i.b)("h3",{id:"querying-by-criteria-dbquery-experimental-sql-compiler"},"Querying by criteria, ",Object(i.b)("inlineCode",{parentName:"h3"},"DB::query")," (experimental SQL Compiler)"),Object(i.b)("p",null,"For being able to run more effective datastore queries, we also have a query\ncompiler. More about this feature is in this\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://medium.com/darklang/compiling-dark-to-sql-bb8918d1acdd"}),"blog post"),"."),Object(i.b)("p",null,"This allows you to write a function that can be evaluated for the datastore."),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/docs/img/datastores/dbquery.png",alt:"DBset"}))),Object(i.b)("p",null,"DB::query allows taking a datastore and a block filter. Note that this does not\ncheck every value in the table but rather is optimized to find data with\nindexes. Errors at compile-time if Dark's compiler does not yet support the code\nin question (please let us know when you hit this, and which function you wanted\nto use!)"),Object(i.b)("p",null,"You can also use ",Object(i.b)("inlineCode",{parentName:"p"},"DB::querywithKey")," to get both the key and record,\n",Object(i.b)("inlineCode",{parentName:"p"},"DB::queryOne")," to get only one response, and ",Object(i.b)("inlineCode",{parentName:"p"},"DB::queryOnewithKey")," to get only\none response, with the key and record."),Object(i.b)("h3",{id:"creating-references-between-dbs"},"Creating References Between DBs"),Object(i.b)("p",null,"This canvas shows the way to create a reference between two datastores: in this\ncase between Dark employees and their pets:\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"https://darklang.com/a/sample-database"}),"https://darklang.com/a/sample-datastore")),Object(i.b)("p",null,"Users have a pets field, which is a list of strings. The keys for the pets are\nadded to that list."),Object(i.b)("h2",{id:"migrations-locking-and-unlocking"},"Migrations, Locking, and Unlocking"),Object(i.b)("p",null,"You can edit the DB\u2019s schema (col names and types) until it has data in it, at\nwhich point it \u201clocks.\u201d"),Object(i.b)("p",null,"If you are still in development and don\u2019t need the data, creating a REPL and\ndeleting all data in a DB will unlock it (",Object(i.b)("inlineCode",{parentName:"p"},"DB::deleteAll"),")."),Object(i.b)("p",null,"Once you have traffic, datastore migrations are manual. To change your schema,\ncreate a new datastore with the new schema."),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/docs/img/datastores/migration.png",alt:"Migration"}))),Object(i.b)("p",null,"Then, use a REPL to write code to move your existing data, using\n",Object(i.b)("inlineCode",{parentName:"p"},"DB::getAllWithKeys")," and ",Object(i.b)("inlineCode",{parentName:"p"},"Dict::map"),". For adding a new field, use ",Object(i.b)("inlineCode",{parentName:"p"},"Dict::set")," to\nadd the new field to the existing record. (Note: to pipe a specific section of\ncode, select it first, then press ",Object(i.b)("inlineCode",{parentName:"p"},"shift-enter"),")"),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/docs/img/datastores/migrator.png",alt:"Migrator"}))),Object(i.b)("p",null,"For removing a field, rebuild the record using the existing one or use\n",Object(i.b)("inlineCode",{parentName:"p"},"Dict::remove"),"."),Object(i.b)("p",null,Object(i.b)("img",Object(a.a)({parentName:"p"},{src:"/docs/img/datastores/migrator2.png",alt:"Migrator2"}))),Object(i.b)("p",null,"Once you are satisfied with your code, run the REPL to test it (if you are just\ntesting, delete the data after). The new datastore should be locked, and you can\nuse another REPL to verify the output looks correct. Set up each reference to\nthe datastore to use the new one datastore within a\n",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/feature-flags"}),"Feature Flag"),"."),Object(i.b)("p",null,"When you're ready to change your traffic to use the new datastore, run the\nmigration, and commit each feature flag."),Object(i.b)("p",null,"Setting DBs by type and DB Migrations are coming, if you have requests or inputs\nplease let us know."),Object(i.b)("h2",{id:"using-an-external-datastore"},"Using an External Datastore"),Object(i.b)("p",null,"We strongly recommend using this built-in datastore. If you have an external\ndatabase, you can ",Object(i.b)("a",Object(a.a)({parentName:"p"},{href:"/docs/tutorials/external-db"}),"connect to it via REST"),"."))}b.isMDXComponent=!0},241:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return m}));var a=n(0),r=n.n(a);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=r.a.createContext({}),b=function(e){var t=r.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=b(e.components);return r.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},p=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,s=c(e,["components","mdxType","originalType","parentName"]),d=b(n),p=a,m=d["".concat(l,".").concat(p)]||d[p]||u[p]||i;return n?r.a.createElement(m,o(o({ref:t},s),{},{components:n})):r.a.createElement(m,o({ref:t},s))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,l=new Array(i);l[0]=p;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o.mdxType="string"==typeof e?e:a,l[1]=o;for(var s=2;s<i;s++)l[s]=n[s];return r.a.createElement.apply(null,l)}return r.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);