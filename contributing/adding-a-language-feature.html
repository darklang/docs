<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-contributing/adding-a-language-feature" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.2">
<title data-rh="true">Adding a language feature | Dark Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.darklang.com/img/favicon.ico"><meta data-rh="true" name="twitter:image" content="https://docs.darklang.com/img/favicon.ico"><meta data-rh="true" property="og:url" content="https://docs.darklang.com/contributing/adding-a-language-feature"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Adding a language feature | Dark Documentation"><meta data-rh="true" name="description" content="There are a number of"><meta data-rh="true" property="og:description" content="There are a number of"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.darklang.com/contributing/adding-a-language-feature"><link data-rh="true" rel="alternate" href="https://docs.darklang.com/contributing/adding-a-language-feature" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.darklang.com/contributing/adding-a-language-feature" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://QFOZBC0VVL-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-159199190-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<link rel="search" type="application/opensearchdescription+xml" title="Dark Documentation" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.1153dd51.css">
<script src="/assets/js/runtime~main.1457a9ab.js" defer="defer"></script>
<script src="/assets/js/main.1097cbc5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://darklang.com" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/favicon.ico" alt="Darklang logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/favicon.ico" alt="Darklang logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Darklang</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/introduction">Classic</a><a class="navbar__item navbar__link" href="/next/introduction">Next</a><a class="navbar__item navbar__link" href="/contributing/getting-started">Contributing</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/contributing/getting-started">Your First Contribution</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/contributing/next-contribution">Your Next Contributions</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/next-contribution">Your next contribution</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/if-you-dont-know-our-stack">If you don&#x27;t know our stack (F#)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/adding-a-function">Adding a built-in function</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/contributing/adding-a-language-feature">Adding a language feature</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/adding-a-refactoring">Adding a refactoring</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/contributing/fsharp-for-dark-developers">Working in the Dark repo</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><span class="breadcrumbs__link">Your Next Contributions</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Adding a language feature</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Adding a language feature</h1></header><p>There are a number of
<a href="https://github.com/darklang/dark/issues?q=is%3Aissue+is%3Aopen+label%3Alanguage-feature" target="_blank" rel="noopener noreferrer">language features that we&#x27;d like to add</a>
to Darklang. While there a quite a few steps involved in adding a language
feature, they&#x27;re typically relatively straightforward to add once you&#x27;ve figured
out the Darklang codebase.</p>
<p>It&#x27;s important to note that the most important part of a language feature is
getting agreement on what it does. We typically write specs for features, and
ensure that we have resolved how edge cases should work, as well as ensuring it
meshes with the rest of the language and language definition. If you&#x27;re
interested in creating a language feature, you should engage with Paul Biggar
early and often.</p>
<p><em>See also:
<a href="https://www.youtube.com/watch?v=HZk4yCF8DWQL" target="_blank" rel="noopener noreferrer">a pairing session where we added Tuples to the Darklang client and backend</a></em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h3>
<p>Most language features will need to be added to our language definition. The
language definition is
<a href="https://github.com/darklang/dark/blob/main/backend/src/LibExecution/ProgramTypes.fs" target="_blank" rel="noopener noreferrer"><code>Expr</code></a>,
which represent a Darklang expression (which in turn contains other Darklang
expressions). This is commonly known as an &quot;Abstract Syntax Tree&quot; (or AST).</p>
<p>At time of writing, the definition of <code>Expr</code> was</p>
<div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">type Expr =</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EInteger of id * bigint</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EBool of id * bool</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EString of id * string</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | ECharacter of id * string</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  // allow the user to have arbitrarily big numbers, even if they don&#x27;t make sense as floats</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EFloat of id * Sign * bigint * bigint</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | ENull of id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EBlank of id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | ELet of id * string * Expr * Expr</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EIf of id * Expr * Expr * Expr</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EBinOp of id * FQFnName.T * Expr * Expr * SendToRail</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | ELambda of id * List&lt;id * string&gt; * Expr</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EFieldAccess of id * Expr * string</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EVariable of id * string</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EFnCall of id * FQFnName.T * List&lt;Expr&gt; * SendToRail</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EPartial of id * string * Expr</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | ERightPartial of id * string * Expr</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | ELeftPartial of id * string * Expr</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EList of id * List&lt;Expr&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | ERecord of id * List&lt;string * Expr&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EPipe of id * Expr * Expr * List&lt;Expr&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EConstructor of id * string * List&lt;Expr&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EMatch of id * Expr * List&lt;Pattern * Expr&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EPipeTarget of id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | EFeatureFlag of id * string * Expr * Expr * Expr</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | ETuple of id * Expr * Expr * List&lt;Expr&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The backend does the work of executing the expressions, and saving programs. The
execution engine is also compiled to WebAssembly in order to be available in the
client.</p>
<p>The client is responsible for editing programs. Typically, adding a language
feature means adding support for it to the many transformations that the client
does, including refactorings, renamings, etc. It will also need support in the
&quot;Fluid&quot; editor, which is where users actually type code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="backend">Backend<a href="#backend" class="hash-link" aria-label="Direct link to Backend" title="Direct link to Backend">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="execution">Execution<a href="#execution" class="hash-link" aria-label="Direct link to Execution" title="Direct link to Execution">​</a></h3>
<p>The execution of the language is defined in
<a href="https://github.com/darklang/dark/blob/main/backend/src/LibExecution/Interpreter.fs" target="_blank" rel="noopener noreferrer"><code>backend/src/LibExecution/Interpreter.fs:eval</code></a>.
<code>eval</code> does the work of converting an expressions into a <code>dval</code> -- a Darklang
value.</p>
<p>For example, <code>DInt</code> is the run-time value of an integer, while <code>EInteger</code> is the
expression that represents an integer. <code>eval</code> converts from an <code>EInteger</code> that
the programmer added to their program, into a <code>DInt</code> that can be operated on
(added, subtracted, etc).</p>
<p>As another example, an <code>ELet</code> is a <code>let</code> statement in Darklang. When you see</p>
<div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">let x = 6</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">x + 4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>you have an <code>ELet (&quot;x&quot;, EInteger 6, EBinOp (&quot;+&quot;, EVariable &quot;x&quot;, EInteger 4))</code>.
When we execute this <code>ELet</code>, we first execute the <code>6</code>, creating a <code>dval</code> of
<code>DInt 6</code>, which we then store as <code>x</code> in a &quot;symbol table&quot;. We then execute
<code>x + 4</code> using the symbol table with our known value of <code>x = 6</code>.</p>
<p><code>dval</code>s are defined in
<a href="https://github.com/darklang/dark/blob/main/backend/src/LibExecution/RuntimeTypes.fs" target="_blank" rel="noopener noreferrer"><code>backend/src/LibExecution/RuntimeTypes.fs</code></a>
and expressions are defined in
<a href="https://github.com/darklang/dark/blob/main/backend/src/LibExecution/ProgramTypes.fs" target="_blank" rel="noopener noreferrer"><code>backend/src/LibExecution/ProgramTypes.fs</code></a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="serialization">Serialization<a href="#serialization" class="hash-link" aria-label="Direct link to Serialization" title="Direct link to Serialization">​</a></h3>
<p>The other main purpose of the backend is to save programs. Darklang uses a fast
binary serialization format, derived directly from expressions. This means you
do not have to do anything special to allow users to save your new expression.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="expressions-are-add-only">Expressions are add-only<a href="#expressions-are-add-only" class="hash-link" aria-label="Direct link to Expressions are add-only" title="Direct link to Expressions are add-only">​</a></h4>
<p>The automatic serialization has a caveat: the serializer has some rules to
maintain compatibility with existing Darklang programs. You can add new
expression types to it, but you can&#x27;t change existing ones. This means that if
you want to change a language feature to make it more powerful, you need to
instead add a new version of it, rather than editing the current version.</p>
<p>We do have the ability to remove old formats, but it is a little challenging to
coordinate. Whenever we do this, it is always after the new replacement feature
is live and stable, and then we go in and remove the old one.</p>
<p>These rules apply to anything using the serializers, which currently includes
both <code>expr</code>s and <code>tipe</code>s.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="editor-support">Editor support<a href="#editor-support" class="hash-link" aria-label="Direct link to Editor support" title="Direct link to Editor support">​</a></h2>
<p>The editor is where the developer (a Darklang user) actually creates code.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fluid-editor">Fluid Editor<a href="#fluid-editor" class="hash-link" aria-label="Direct link to Fluid Editor" title="Direct link to Fluid Editor">​</a></h3>
<p>The &quot;fluid&quot; editor is the subpart of the client where users type code. It
handles keypresses and the AST transformations that they cause.</p>
<p>For example: if you have the code (with the cursor denoted as <code>|</code>):</p>
<div class="language-fsharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-fsharp codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">let x = |6</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">x + 4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Pressing <code>1</code> with your cursor here makes the editor look up the current
expression, and add a <code>1</code> to the front of it. Here that converts <code>6</code> into <code>16</code>.</p>
<p>Over time we intend to expand the Fluid Editor for all &quot;coding&quot; text entry.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="adding-tokens">Adding tokens<a href="#adding-tokens" class="hash-link" aria-label="Direct link to Adding tokens" title="Direct link to Adding tokens">​</a></h4>
<p>The FluidEditor works as a sort of &quot;reverse parser&quot;. Instead of reading text and
figuring out meaning, it instead takes the AST and pretty-prints it into a set
of <code>FluidToken</code>s. These tokens are stringified, showing the user textual code.</p>
<p>The tokens also tied the current edit back to an expression. In the example
above, the cursor is at the start of a <code>TInteger</code> token, which ties the current
position back to the <code>EInteger</code> expression that defines it.</p>
<p>To add a language feature, you will often need to add new tokens. You will
occasionally reuse some tokens, but most features use dedicated tokens so that
there&#x27;s no ambiguity.</p>
<p>You add tokens in
<a href="https://github.com/darklang/dark/blob/main/client/src/fluid/FluidTypes.res" target="_blank" rel="noopener noreferrer"><code>client/src/fluid/FluidTypes.res</code></a>
and keystrokes are handled in
<a href="https://github.com/darklang/dark/blob/main/client/src/fluid/Fluid.res" target="_blank" rel="noopener noreferrer"><code>client/src/fluid/Fluid.res:updateKey</code></a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ast-transformations">AST transformations<a href="#ast-transformations" class="hash-link" aria-label="Direct link to AST transformations" title="Direct link to AST transformations">​</a></h3>
<p>Once you have added the expression and the tokens, you will need to support
existing features. Mostly, this means that existing AST transformations and
refactorings should continue to work. These are typically either explicit (via
the command palette) or implicit (by renaming a variable).</p>
<p>You will be able to find almost everywhere that this is needed when you add the
definition to <code>Expr</code>. The compiler will warn you at every place that you have
not handled it.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="clientbackend-communication">Client/backend communication<a href="#clientbackend-communication" class="hash-link" aria-label="Direct link to Client/backend communication" title="Direct link to Client/backend communication">​</a></h2>
<p>The client sends ASTs to the backend to save and to run the programs in the
cloud. The client also fetches expressions from the backend to display and edit
them. It does this over JSON.</p>
<p>Any types used in client-server communication (e.g. for API calls) are generally
protected from accidentally updating a type and causing breakage in
communication. In the backend, a
<a href="https://github.com/darklang/dark/blob/main/backend/src/ClientTypes" target="_blank" rel="noopener noreferrer"><code>ClientTypes</code></a>
project is defined where these types live. These include core types such as in
the <code>ClientTypes.ProgramTypes</code> module that may be used throughout client/server
communciation, as well as types specific to one use case, such as in
<code>ClientTypes.Api</code>. Adjacent projects <code>ClientTypes2ExecutionTypes</code> and
<code>ClientTypes2BackendTypes</code> are used to map between &#x27;internal&#x27; types and the
<code>ClientTypes</code> that are used in client-server communication. These <code>ClientTypes</code>
are individually registered as types we allow to be serialized/deserialized
through our &quot;Vanilla&quot; JSON serializer, which is based on <code>System.Text.Json</code>.</p>
<p>In the client, encoders and decoders are hand-written to match the <code>ClientTypes</code>
defined in the backend. Many of these exist in <code>client/src/core</code>, and others are
spread throughout the codebase wherever client/server communication happens
(e.g. in <code>client/src/api</code>).</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/darklang/docs/edit/main/docs-classic/contributing/adding-a-language-feature.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/contributing/adding-a-function"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Adding a built-in function</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/contributing/adding-a-refactoring"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Adding a refactoring</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#backend" class="table-of-contents__link toc-highlight">Backend</a><ul><li><a href="#execution" class="table-of-contents__link toc-highlight">Execution</a></li><li><a href="#serialization" class="table-of-contents__link toc-highlight">Serialization</a></li></ul></li><li><a href="#editor-support" class="table-of-contents__link toc-highlight">Editor support</a><ul><li><a href="#fluid-editor" class="table-of-contents__link toc-highlight">Fluid Editor</a></li><li><a href="#ast-transformations" class="table-of-contents__link toc-highlight">AST transformations</a></li></ul></li><li><a href="#clientbackend-communication" class="table-of-contents__link toc-highlight">Client/backend communication</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learning</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://darklang.com/launch/demo-video" target="_blank" rel="noopener noreferrer" class="footer__link-item">Demo Video</a></li><li class="footer__item"><a href="https://youtube.com/c/Darklang/videos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Tutorial Videos</a></li><li class="footer__item"><a href="https://darklang.com/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/tutorials/first-dark-application">Tutorial</a></li><li class="footer__item"><a class="footer__link-item" href="/category/walk-throughs">Walk-throughs</a></li></ul></div><div class="col footer__col"><div class="footer__title">About</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://darklang.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Company</a></li><li class="footer__item"><a href="https://blog.darklang.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://darklang.com/discord-invite" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community Discord</a></li><li class="footer__item"><a href="https://github.com/darklang/dark" target="_blank" rel="noopener noreferrer" class="footer__link-item">Dark Repo</a></li><li class="footer__item"><a href="https://github.com/darklang/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docs Repo</a></li><li class="footer__item"><a class="footer__link-item" href="/contributing/getting-started">Contributor Docs</a></li><li class="footer__item"><a href="https://darklang.com/code-of-conduct" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code of Conduct</a></li></ul></div><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://darklang.com/login" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sign in</a></li><li class="footer__item"><a href="https://darklang.com/signup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sign up</a></li><li class="footer__item"><a href="https://darklang.com/desktop-client" target="_blank" rel="noopener noreferrer" class="footer__link-item">Desktop Client</a></li><li class="footer__item"><a href="https://darklang.com/mailing-list" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mailing List</a></li><li class="footer__item"><a class="footer__link-item" href="/changelog">Changelog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Dark Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>