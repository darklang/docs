<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.7">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-159199190-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Dark Documentation" href="/opensearch.xml">
<link rel="preconnect" href="https://cdn.heapanalytics.com">
<link rel="dns-prefetch" href="https://cdn.heapanalytics.com">
<script>window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=document.createElement("script");r.type="text/javascript",r.async=!0,r.src="https://cdn.heapanalytics.com/js/heap-"+e+".js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(r,a);for(var n=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","resetIdentity","removeEventProperty","setEventProperties","track","unsetEventProperty"],o=0;o<p.length;o++)heap[p[o]]=n(p[o])},heap.load(477722926)</script>
<link rel="preconnect" href="https://cdn.heysavvy.com">
<link rel="dns-prefetch" href="https://cdn.heysavvy.com"><title data-react-helmet="true">A tour of the Backend | Dark Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://docs.darklang.com/img/favicon.ico"><meta data-react-helmet="true" name="twitter:image" content="https://docs.darklang.com/img/favicon.ico"><meta data-react-helmet="true" property="og:url" content="https://docs.darklang.com/contributing/tour-of-backend"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="A tour of the Backend | Dark Documentation"><meta data-react-helmet="true" name="description" content="The journey of a HTTP request"><meta data-react-helmet="true" property="og:description" content="The journey of a HTTP request"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.darklang.com/contributing/tour-of-backend"><link data-react-helmet="true" rel="alternate" href="https://docs.darklang.com/contributing/tour-of-backend" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.darklang.com/contributing/tour-of-backend" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://QFOZBC0VVL-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.e5ea1f16.css">
<link rel="preload" href="/assets/js/runtime~main.1f3903eb.js" as="script">
<link rel="preload" href="/assets/js/main.4e7d1b57.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://darklang.com" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/favicon.ico" alt="Dark logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/favicon.ico" alt="Dark logo" class="themedImage_1VuW themedImage--dark_hz6m"></div><b class="navbar__title">Dark</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/introduction">Documentation</a><a class="navbar__item navbar__link" href="/tutorials/tutorial-intro">Tutorials &amp; Samples</a><a class="navbar__item navbar__link" href="/slack-apps/slack-intro">Building Slack Apps</a><a class="navbar__item navbar__link" href="/contributing/getting-started">Contributing</a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Your First Contribution</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Your Next Contributions</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Working in the Dark repo</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/rescript-and-fsharp-for-dark-developers">ReScript and F# for Dark developers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/general-concepts">General concepts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/tour-of-editor">A tour of the Editor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/contributing/tour-of-backend">A tour of the Backend</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/repo-layout">Repository directory structure</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/glossary">Glossary</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/debugging">Debugging</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/troubleshooting">Troubleshooting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contributing/making-a-pull-request">Making a Pull Request</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>A tour of the Backend</h1></header><h2 class="anchor anchorWithStickyNavbar_31ik" id="the-journey-of-a-http-request">The journey of a HTTP request<a aria-hidden="true" class="hash-link" href="#the-journey-of-a-http-request" title="Direct link to heading">â€‹</a></h2><p>When the users of a Dark developer&#x27;s app (we refer to them as &quot;grand-users&quot;)
makes a request to a Dark app, it makes it&#x27;s way directly to the developer&#x27;s
editor.</p><p>Here&#x27;s the journey it takes:</p><ul><li>Google Load Balancer</li><li>Nginx sidecar container</li><li>the Dark
<a href="https://github.com/darklang/dark/blob/main/fsharp-backend/src/BwdServer/Server.fs" target="_blank" rel="noopener noreferrer">BwdServer</a>
(<code>bwd</code> stands for <code>BuiltWithDark</code>)</li><li>our webserver is built on top of ASP.NET, and it directs the request to
<a href="https://github.com/darklang/dark/blob/main/fsharp-backend/src/BwdServer/Server.fs" target="_blank" rel="noopener noreferrer">BwdServer</a>.runDarkHandler.</li><li>if it&#x27;s a 404, the trace is stored in the <code>stored_events_v2</code> table and sent
to the client as a 404 via
<a href="https://pusher.com" target="_blank" rel="noopener noreferrer">Pusher</a></li><li>if a page is found, the request path, body, and headers are passed to the
<a href="https://github.com/darklang/dark/blob/main/fsharp-backend/src/HttpMiddleware/MiddlewareV0.fs" target="_blank" rel="noopener noreferrer">HttpMiddleware</a>, which creates the <code>request</code> parameter, run the code, and converts the response into the correct formats.</li><li><a href="https://github.com/darklang/dark/blob/main/fsharp-backend/src/LibExecution/Interpreter.fs" target="_blank" rel="noopener noreferrer"><code>Interpreter.eval</code></a>
runs the Dark code, saving parts of the trace as it goes. Input values,
function arguments and return values are saved in Postgres tables
<code>stored_events_v2</code>, <code>function_arguments</code> and <code>function_results_v2</code></li><li>A trace is pushed to <a href="https://pusher.com" target="_blank" rel="noopener noreferrer">Pusher</a>, which forwards it to the
editor, where it appears as a dot on the canvas.</li><li>When a user clicks on the trace, the trace is loaded from the server. A web
worker named
<a href="https://github.com/darklang/dark/blob/main/client/workers/Fetcher.res" target="_blank" rel="noopener noreferrer"><code>Fetcher</code></a>
fetches the trace in the background, decodes it, and sends the value to the
editor. On the server-side, it is fetched from the
<a href="https://github.com/darklang/dark/blob/main/fsharp-backend/src/ApiServer/Api.fs" target="_blank" rel="noopener noreferrer">ApiServer</a>.</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="traces">Traces<a aria-hidden="true" class="hash-link" href="#traces" title="Direct link to heading">â€‹</a></h2><p>A trace is a combination of an event (referred to in Dark as an &quot;input value&quot;
and in the code as <code>StoredEvent</code>), and the arguments and results of functions
called during the trace:</p><ul><li>event refers to the HTTP request, worker event, or in the case of Crons, an
empty value, that is used to trigger the event handler</li><li>the trace includes information for every call to every function during the
event. For built-in functions, we record a hash of the arguments and the
result. For canvas functions, we also store the arguments to the function.</li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="serialization">Serialization<a aria-hidden="true" class="hash-link" href="#serialization" title="Direct link to heading">â€‹</a></h2><p>Dark programs are directly serialized in our database, and loaded for any
requests that come in. Each change in the editor creates an Op for that toplevel
(DB, handler, function, etc). That is appended to the list of previous ops for
that handler, and serialized into the DB in an efficient binary format.</p><p>The ops contain the entire handler or function, which is much slower than it
could be (part of the reason that <code>undo</code> is so slow.</p><p>We cache/denormalize the current code for each handler, which makes requests
fast.</p><p>One downside of this is that we have to be very careful what changes we make the
Dark AST definition. There is a doc in the dark repo discussing this in more
detail.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="libexecution-and-the-editor"><code>Libexecution</code> and the editor<a aria-hidden="true" class="hash-link" href="#libexecution-and-the-editor" title="Direct link to heading">â€‹</a></h2><p><a href="https://github.com/darklang/dark/tree/main/fsharp-backend/src/LibExecution" target="_blank" rel="noopener noreferrer"><code>LibExecution</code></a>
is the &quot;execution engine&quot; of Dark. The same code is compiled to native code to
respond to HTTP handlers, and is also compiled to WASM to run in the editor.</p><p>The play button on functions and on handlers executes the code on the server,
returning updates to the trace of those functions. In all other cases, the
editor runs code in the JS version, filling in the results of the functions it
doesn&#x27;t have access to from the traces.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="standard-library">Standard library<a aria-hidden="true" class="hash-link" href="#standard-library" title="Direct link to heading">â€‹</a></h2><p>The standard library is split between
<a href="https://github.com/darklang/dark/tree/main/fsharp-backend/src/LibExecutionStdLib" target="_blank" rel="noopener noreferrer"><code>fsharp-backend/src/LibExecutionStdLib</code></a>
(for functions which are available on the client and backend) and
<a href="https://github.com/darklang/dark/tree/main/fsharp-backend/src/BackendOnlyStdLib" target="_blank" rel="noopener noreferrer"><code>fsharp-backend/src/BackendOnlyStdLib</code></a>
for functions which are only available on the backend (typically functions where
we cannot compile some library to JS).</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/darklang/docs/edit/main/docs/contributing/tour-of-backend.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/contributing/tour-of-editor"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->A tour of the Editor</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/contributing/repo-layout"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Repository directory structure<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-journey-of-a-http-request" class="table-of-contents__link toc-highlight">The journey of a HTTP request</a></li><li><a href="#traces" class="table-of-contents__link toc-highlight">Traces</a></li><li><a href="#serialization" class="table-of-contents__link toc-highlight">Serialization</a></li><li><a href="#libexecution-and-the-editor" class="table-of-contents__link toc-highlight"><code>Libexecution</code> and the editor</a></li><li><a href="#standard-library" class="table-of-contents__link toc-highlight">Standard library</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learning</div><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/launch/demo-video" target="_blank" rel="noopener noreferrer" class="footer__link-item">Demo Video</a></li><li class="footer__item"><a href="https://youtube.com/c/Darklang/videos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Tutorial Videos</a></li><li class="footer__item"><a href="https://darklang.com/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docs</a></li><li class="footer__item"><a href="https://darklang.com/docs/tutorials" target="_blank" rel="noopener noreferrer" class="footer__link-item">Tutorials &amp; Samples</a></li><li class="footer__item"><a href="https://darklang.com/docs/slack-apps" target="_blank" rel="noopener noreferrer" class="footer__link-item">Building Slack Apps</a></li></ul></div><div class="col footer__col"><div class="footer__title">About</div><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/about" target="_blank" rel="noopener noreferrer" class="footer__link-item">Company</a></li><li class="footer__item"><a href="https://dev.to/darklang" target="_blank" rel="noopener noreferrer" class="footer__link-item">Dev Blog</a></li><li class="footer__item"><a href="https://blog.darklang.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Corp Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/slack-invite" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community Slack</a></li><li class="footer__item"><a href="https://github.com/darklang/dark" target="_blank" rel="noopener noreferrer" class="footer__link-item">Dark Repo</a></li><li class="footer__item"><a href="https://github.com/darklang/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docs Repo</a></li><li class="footer__item"><a class="footer__link-item" href="/contributing/getting-started">Contributor Docs</a></li><li class="footer__item"><a href="https://darklang.com/code-of-conduct" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code of Conduct</a></li></ul></div><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items"><li class="footer__item"><a href="https://darklang.com/login" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sign in</a></li><li class="footer__item"><a href="https://darklang.com/signup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sign up</a></li><li class="footer__item"><a href="https://darklang.com/desktop-client" target="_blank" rel="noopener noreferrer" class="footer__link-item">Desktop Client</a></li><li class="footer__item"><a href="https://darklang.com/mailing-list" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mailing List</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Dark Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.1f3903eb.js"></script>
<script src="/assets/js/main.4e7d1b57.js"></script>
<script async="true" defer="true" src="https://cdn.heysavvy.com/wc/savvy.min.js"></script>
        <savvy-smart-form id="6HBmUjmI12nCuopyvB0B"></savvy-smart-form></body>
</html>