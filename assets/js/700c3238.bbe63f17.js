"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6627],{59672:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>l,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var r=t(74848),i=t(28453);const a={title:"A tour of the Backend"},s=void 0,o={id:"contributing/tour-of-backend",title:"A tour of the Backend",description:"The journey of a HTTP request",source:"@site/docs-classic/contributing/tour-of-backend.md",sourceDirName:"contributing",slug:"/contributing/tour-of-backend",permalink:"/contributing/tour-of-backend",draft:!1,unlisted:!1,editUrl:"https://github.com/darklang/docs/edit/main/docs-classic/contributing/tour-of-backend.md",tags:[],version:"current",frontMatter:{title:"A tour of the Backend"},sidebar:"Contributing",previous:{title:"General concepts",permalink:"/contributing/general-concepts"},next:{title:"Repository directory structure",permalink:"/contributing/repo-layout"}},c={},d=[{value:"The journey of a HTTP request",id:"the-journey-of-a-http-request",level:2},{value:"Traces",id:"traces",level:2},{value:"Serialization",id:"serialization",level:2},{value:"<code>LibExecution</code> and the editor",id:"libexecution-and-the-editor",level:2},{value:"Standard library",id:"standard-library",level:2}];function h(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"the-journey-of-a-http-request",children:"The journey of a HTTP request"}),"\n",(0,r.jsx)(n.p,{children:"When the users of a Darklang developer's app (we refer to them as \"grand-users\")\nmakes a request to a Darklang app, it makes it's way directly to the developer's\neditor."}),"\n",(0,r.jsx)(n.p,{children:"Here's the journey it takes:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Google Load Balancer"}),"\n",(0,r.jsxs)(n.li,{children:["the Darklang\n",(0,r.jsx)(n.a,{href:"https://github.com/darklang/dark/blob/main/backend/src/BwdServer/Server.fs",children:"BwdServer"}),"\n(",(0,r.jsx)(n.code,{children:"bwd"})," stands for ",(0,r.jsx)(n.code,{children:"BuiltWithDark"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["our webserver is built on top of ASP.NET, and it directs the request to\n",(0,r.jsx)(n.a,{href:"https://github.com/darklang/dark/blob/main/backend/src/BwdServer/Server.fs",children:"BwdServer"}),".runDarkHandler."]}),"\n",(0,r.jsxs)(n.li,{children:["if it's a 404, the trace is stored in the ",(0,r.jsx)(n.code,{children:"stored_events_v2"})," table and sent to\nthe client as a 404 via ",(0,r.jsx)(n.a,{href:"https://pusher.com",children:"Pusher"})]}),"\n",(0,r.jsxs)(n.li,{children:["if a page is found, the request path, body, and headers are passed to the\n",(0,r.jsx)(n.a,{href:"https://github.com/darklang/dark/blob/main/backend/src/HttpMiddleware",children:"HttpMiddleware"}),",\nwhich creates the ",(0,r.jsx)(n.code,{children:"request"})," parameter, run the code, and converts the response\ninto the correct formats."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://github.com/darklang/dark/blob/main/backend/src/LibExecution/Interpreter.fs",children:(0,r.jsx)(n.code,{children:"Interpreter.eval"})}),"\nruns the Darklang code, saving parts of the trace as it goes. Input values,\nfunction arguments and return values are saved in Postgres tables\n",(0,r.jsx)(n.code,{children:"stored_events_v2"}),", ",(0,r.jsx)(n.code,{children:"function_arguments"})," and ",(0,r.jsx)(n.code,{children:"function_results_v2"})]}),"\n",(0,r.jsxs)(n.li,{children:["A trace is pushed to ",(0,r.jsx)(n.a,{href:"https://pusher.com",children:"Pusher"}),", which forwards it to the\neditor."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"traces",children:"Traces"}),"\n",(0,r.jsxs)(n.p,{children:['A trace is a combination of an event (referred to in Darklang as an "input\nvalue" and in the code as ',(0,r.jsx)(n.code,{children:"StoredEvent"}),"), and the arguments and results of\nfunctions called during the trace:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"event refers to the HTTP request, worker event, or in the case of Crons, an\nempty value, that is used to trigger the event handler"}),"\n",(0,r.jsx)(n.li,{children:"the trace includes information for every call to every function during the\nevent. For built-in functions, we record a hash of the arguments and the\nresult. For canvas functions, we also store the arguments to the function."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"serialization",children:"Serialization"}),"\n",(0,r.jsx)(n.p,{children:"Darklang programs are directly serialized in our database, and loaded for any\nrequests that come in. Each change in the editor creates an Op for that toplevel\n(DB, handler, function, etc). That is appended to the list of previous ops for\nthat handler, and serialized into the DB in an efficient binary format."}),"\n",(0,r.jsxs)(n.p,{children:["The ops contain the entire handler or function, which is much slower than it\ncould be (part of the reason that ",(0,r.jsx)(n.code,{children:"undo"})," is so slow."]}),"\n",(0,r.jsx)(n.p,{children:"We cache/denormalize the current code for each handler, which makes requests\nfast."}),"\n",(0,r.jsx)(n.p,{children:"One downside of this is that we have to be very careful what changes we make the\nDarklang AST definition. There is a doc in the dark repo discussing this in more\ndetail."}),"\n",(0,r.jsxs)(n.h2,{id:"libexecution-and-the-editor",children:[(0,r.jsx)(n.code,{children:"LibExecution"})," and the editor"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"https://github.com/darklang/dark/tree/main/backend/src/LibExecution",children:(0,r.jsx)(n.code,{children:"LibExecution"})}),'\nis the "execution engine" of Darklang. The same code is compiled to native code\nto respond to HTTP handlers, and is also compiled to WASM to run in the editor.']}),"\n",(0,r.jsx)(n.p,{children:"The play button on functions and on handlers executes the code on the server,\nreturning updates to the trace of those functions. In all other cases, the\neditor runs code in the WASM version, filling in the results of the functions it\ndoesn't have access to (e.g. DB calls) from the traces."}),"\n",(0,r.jsx)(n.h2,{id:"standard-library",children:"Standard library"}),"\n",(0,r.jsxs)(n.p,{children:["The standard library is split between\n",(0,r.jsx)(n.a,{href:"https://github.com/darklang/dark/tree/main/backend/src/LibExecutionStdLib",children:(0,r.jsx)(n.code,{children:"backend/src/LibExecutionStdLib"})}),"\n(for functions which are available on the client and backend) and\n",(0,r.jsx)(n.a,{href:"https://github.com/darklang/dark/tree/main/backend/src/BackendOnlyStdLib",children:(0,r.jsx)(n.code,{children:"backend/src/BackendOnlyStdLib"})}),"\nfor functions which are only available on the backend (typically functions where\nwe cannot compile some library to WASM)."]})]})}function l(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var r=t(96540);const i={},a=r.createContext(i);function s(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);