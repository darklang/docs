"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[8063],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>c});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),u=p(n),c=r,k=u["".concat(s,".").concat(c)]||u[c]||m[c]||i;return n?a.createElement(k,l(l({ref:t},d),{},{components:n})):a.createElement(k,l({ref:t},d))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=u;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var p=2;p<i;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},63403:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>s,default:()=>c,frontMatter:()=>o,metadata:()=>p,toc:()=>m});var a=n(87462),r=n(63366),i=(n(67294),n(3905)),l=["components"],o={},s="Darklang Release 2",p={unversionedId:"changelog/release-2",id:"changelog/release-2",title:"Darklang Release 2",description:"June 6th, 2022",source:"@site/docs/changelog/release-2.md",sourceDirName:"changelog",slug:"/changelog/release-2",permalink:"/changelog/release-2",draft:!1,editUrl:"https://github.com/darklang/docs/edit/main/docs/changelog/release-2.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Darklang Release 3",permalink:"/changelog/release-3"},next:{title:"Darklang Release 1",permalink:"/changelog/release-1"}},d={},m=[{value:"Major changes",id:"major-changes",level:2},{value:"Error messages",id:"error-messages",level:3},{value:"<code>Result.Error</code>s",id:"resulterrors",level:4},{value:"Runtime errors",id:"runtime-errors",level:4},{value:"Minor improvements and fixes",id:"minor-improvements-and-fixes",level:2},{value:"Breaking changes",id:"breaking-changes",level:2},{value:"String casing",id:"string-casing",level:3},{value:"String ordering",id:"string-ordering",level:3},{value:"HTTP Clients",id:"http-clients",level:3},{value:"Generating JSON",id:"generating-json",level:3},{value:"Parsing JSON",id:"parsing-json",level:3},{value:"HTTP stack",id:"http-stack",level:3},{value:"Testing changes",id:"testing-changes",level:2},{value:"Operational changes",id:"operational-changes",level:2},{value:"Documentation changes",id:"documentation-changes",level:2},{value:"Contributing changes",id:"contributing-changes",level:2}],u={toc:m};function c(e){var t=e.components,n=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"darklang-release-2"},"Darklang Release 2"),(0,i.kt)("p",null,"June 6th, 2022"),(0,i.kt)("p",null,(0,i.kt)("em",{parentName:"p"},"See the ",(0,i.kt)("a",{parentName:"em",href:"https://blog.darklang.com/darklang-release-3/"},"blog post")," for further\ndiscussion.")),(0,i.kt)("p",null,"Darklang Release 2 is the culmination of 20 months work of rewriting the backend\nfrom OCaml to F#. This was done to give us more productivity by allowing us use\nmore 3rd party SDKs, to solve operational issues, and to make it easier to\ncontribute. Our reasons for making the change were discussed at the time:\n",(0,i.kt)("a",{parentName:"p",href:"https://blog.darklang.com/new-backend-fsharp/"},"1"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://blog.darklang.com/why-dark-didnt-choose-rust/"},"2"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://blog.darklang.com/leaving-ocaml/"},"3"),"."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The editor backend was fully migrated by April 2nd."),(0,i.kt)("li",{parentName:"ul"},"HTTP backends (for builtwithdark.com) were finished converting on May 3rd."),(0,i.kt)("li",{parentName:"ul"},"The migration to the new queues was fully converted on May 27th."),(0,i.kt)("li",{parentName:"ul"},"The execution engine in the editor was switched over on June 5th.")),(0,i.kt)("p",null,"The change was documented in a series of blog posts:\n",(0,i.kt)("a",{parentName:"p",href:"https://blog.darklang.com/hows-the-dark-rewrite-going/"},"1"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://blog.darklang.com/changes-the-the-dark-rewrite/"},"2"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://blog.darklang.com/optimizing-tasks-in-fsharp/"},"3"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://blog.darklang.com/benchmarking-fsharp6-tasks/"},"4"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://blog.darklang.com/darklang-year-in-review-2021/"},"5"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://blog.darklang.com/try-out-the-new-darklang-backend/"},"6"),", and\n",(0,i.kt)("a",{parentName:"p",href:"https://blog.darklang.com/backend-rewrite-complete/"},"7"),"."),(0,i.kt)("p",null,"Thanks to everyone who contributed, including\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/Athinanarof"},"Araceli S\xe1nchez"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/levlaz"},"Lev Lazinskiy"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/mariajdab"},"Mar\xeda Jos\xe9 D\xe1vila"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/mjeffryes"},"Matthew Jeffryes"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/jwalter"},"jwalter"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/danicampagna"},"Daniela Campagna"),",\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/sxmanton"},"Sean Manton"),", and especially\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/stachudotnet"},"Stachu Korick"),"."),(0,i.kt)("h2",{id:"major-changes"},"Major changes"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Darklang's implementation is now asynchronous, meaning that your programs will\nno longer be stuck behind other users' programs making HTTP or DB calls. This\nwas a major source of slow Dark programs experienced by most users."),(0,i.kt)("p",{parentName:"li"},"As well as massively reducing latency for programs written in Dark, the editor\nnow loads much faster."),(0,i.kt)("p",{parentName:"li"},"We have also switched from dozens of tiny machines to a smaller number of much\nmore powerful machines. This makes your programs run faster on average, even\nwhen accounting for the switch to an asynchronous implementation.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"You can now put a lambda in a variable and pipe into it.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Most error messages are improved, especially for bad input.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The queues have been rewritten and should not longer suffer from the old\nsources of occasional downtime and slow-down.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"During a deploy of the Dark service, cron jobs no longer run the risk of\nrunning twice.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"There is now a ",(0,i.kt)("a",{parentName:"p",href:"https://status.darklang.com"},"Status page"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Dark's internal firewalls have been significantly improved")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Several bottlenecks to outbound HTTP requests have been identified and removed")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"String::length")," is now ",(0,i.kt)("inlineCode",{parentName:"p"},"O(1)")," instead of ",(0,i.kt)("inlineCode",{parentName:"p"},"O(N)"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"JSON output is now significantly faster")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"When reading strings from a user, the string is only passed over once.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Traces are now stored in the background, after a request has completed,\ngreatly reducing response time on HTTP requests to Dark programs.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Dark has moved to more powerful cloud machines, going from Google' Cloud's\ndeprecated N1 machines to extremely powerful T2D machines (2.3x faster)")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The rewrite also addressed some underlying issues that will come out in new\nfeatures soon, including a better type system, support for characters and\ntuples, fixes for poor behavior in Date and String functions, and more. These\nissues are tracked in our new\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/darklang/dark/projects/1#column-15173588"},"project tracker"),"."))),(0,i.kt)("h3",{id:"error-messages"},"Error messages"),(0,i.kt)("p",null,"All error messages have been renovated, attempting to make them more consistent\nand to reuse error message machinery. As a result, a majority of Dark error\nmessages have changed. If you were relying on the explicit format of a Dark\nlanguage or StdLib error message, expect that it will be different."),(0,i.kt)("p",null,"If you do any error handling which relies specifically on the text of an error\nmessage coming from Dark, we recommend you no longer do that, and just use the\npresence of the error instead of the text."),(0,i.kt)("p",null,"There are two places in Dark which use string error messages:"),(0,i.kt)("h4",{id:"resulterrors"},(0,i.kt)("inlineCode",{parentName:"h4"},"Result.Error"),"s"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Error")," enum (referred to as ",(0,i.kt)("inlineCode",{parentName:"p"},"Result.Error")," below for clarity), will contain\na string error in most cases, which you might be using directly or indirectly."),(0,i.kt)("p",null,"You might be accessing ",(0,i.kt)("inlineCode",{parentName:"p"},"Result.Error"),"s and their text contents directly using\nthe ",(0,i.kt)("inlineCode",{parentName:"p"},"match")," statement."),(0,i.kt)("p",null,"You might also be accessing their text contents indirectly, using ",(0,i.kt)("inlineCode",{parentName:"p"},"toString"),", or\nother stringifying functions, such as ",(0,i.kt)("inlineCode",{parentName:"p"},"toString"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"JSON::")," functions and\n",(0,i.kt)("inlineCode",{parentName:"p"},"HTTPClient::")," functions. This is only true if you taken the function returning\nthe ",(0,i.kt)("inlineCode",{parentName:"p"},"Result.Error")," off the error rail. This text may also make it to your\nweb/mobile clients or API consumers."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Result.Error"),"s returned via a HTTP handler are not presented to the user, so\ntext cannot leak that way."),(0,i.kt)("h4",{id:"runtime-errors"},"Runtime errors"),(0,i.kt)("p",null,"Runtime errors (including type errors) are not accessible via Dark programs, and\nwill always terminate the Dark program when they are accessed. As a result, the\ntext of any runtime error should not be accessible to your programs or your\nusers."),(0,i.kt)("h2",{id:"minor-improvements-and-fixes"},"Minor improvements and fixes"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Dark used to return the ",(0,i.kt)("inlineCode",{parentName:"p"},"Access-Control-Allow-Origin")," header in lower-case, it\nis now returned in mixed case.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"When making a web request to your Dark application, if you did not specific a\n",(0,i.kt)("inlineCode",{parentName:"p"},"user-agent")," header, Dark used to add a ",(0,i.kt)("inlineCode",{parentName:"p"},"user-agent")," header of\n",(0,i.kt)("inlineCode",{parentName:"p"},"ocaml-cohttp/1.2.0"),". We no longer add this header.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"When making a web request to your Dark application with a ",(0,i.kt)("inlineCode",{parentName:"p"},"content-type"),"\nheader of ",(0,i.kt)("inlineCode",{parentName:"p"},"text/ping"),", Dark used to ignore the code and immediately return a\nresponse of status code 418. It now processes the request instead.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"HttpClient::*")," functions called with usernames and passwords in the URL can\nnow support arbitrary UTF-8 (in the past, Unicode was not supported.)")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"X509::pemCertificatePublicKeys")," used to only work for RSA keys. It now also\nsupports DSA and ECDSA keys. The old version would read ECDSA keys and return\nan incorrect answer - it now returns a correct answer.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"String::split")," would fail if the 2nd argument was ",(0,i.kt)("inlineCode",{parentName:"p"},'""')," and the first argument\nwas a complex Unicode character, such as ",(0,i.kt)("inlineCode",{parentName:"p"},'String::split "\ud83d\udc68\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83d\udc69\u200d\ud83d\udc69\u200d\ud83d\udc67\u200d\ud83d\udc66\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f\u200d\ufe0f\ud83c\uddf5\ud83c\uddf7" ""'),". This\nis now split correctly.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"String.trim"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"String::trimEnd")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"String::trimStart")," worked incorrectly in\nsome Unicode situations, they now work correctly."))),(0,i.kt)("h2",{id:"breaking-changes"},"Breaking changes"),(0,i.kt)("p",null,"These breaking changes were documented and announced many months in advance of\nswitching over to the new version of Darklang. We also very careful deployed the\nnew code, watching for suspicious changes in any Dark programs that were\nrunning. In the rare case where something went awry, we contacted the users and\nworked with them to ensure a seamless transition."),(0,i.kt)("h3",{id:"string-casing"},"String casing"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"String::toLowercase_v0")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"String::toUppercase_v0")," worked correctly in the\nold version of Dark, for all unicode. In the new version, the library we are\nusing does not correctly handle some case changes, instead keeping the\noriginal character. This happens when the replacement is a different length\nthan the character being replaced (for example, ",(0,i.kt)("inlineCode",{parentName:"li"},'"\u0587"')," should be ",(0,i.kt)("inlineCode",{parentName:"li"},'"\u0535\u0552"')," when\nconverted to upper case, which the old version did correctly and the new\nversion does not). We plan to fix this at a later point.")),(0,i.kt)("h3",{id:"string-ordering"},"String ordering"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Functions whose output relies on the internal ordering of a ",(0,i.kt)("inlineCode",{parentName:"p"},"Dict")," may have\ndifferent outputs, specifically, the output Lists may be in a different order.\nExamples include ",(0,i.kt)("inlineCode",{parentName:"p"},"Dict::keys"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"Dict::values"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"Dict::toList")," which return\n",(0,i.kt)("inlineCode",{parentName:"p"},"List"),"s of values which are ordered based on the internal ordering in the\noriginal ",(0,i.kt)("inlineCode",{parentName:"p"},"Dict"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"When calling ",(0,i.kt)("inlineCode",{parentName:"p"},"List::uniqueBy"),", and there is a duplicate, the new version of\nDark may pick a different value for the duplicate. For example:"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-dark"},"List.uniqueBy_v0 [1;2;3;4] (fun x -> Int.divide_v0 x 2) = [ 1, 3, 4 ] // old Dark\nList.uniqueBy_v0 [1;2;3;4] (fun x -> Int.divide_v0 x 2) = [ 1, 2, 4 ] // new Dark\n")),(0,i.kt)("h3",{id:"http-clients"},"HTTP Clients"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"HttpClient::*")," functions no longer support making requests with arbitrary\n",(0,i.kt)("inlineCode",{parentName:"li"},"Content-Type"),"s. They must now be\n",(0,i.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type"},"valid"),",\nfor example ",(0,i.kt)("inlineCode",{parentName:"li"},'"application/json"')," or ",(0,i.kt)("inlineCode",{parentName:"li"},'"application/json; charset=utf-8"'),".")),(0,i.kt)("h3",{id:"generating-json"},"Generating JSON"),(0,i.kt)("p",null,"We have changed how JSON is generated in many cases. All the JSON generated by\nDark is now standards compliant, and uses a different formatting style."),(0,i.kt)("p",null,"In the old version of Dark, we would generate invalid JSON for the Float values\n",(0,i.kt)("inlineCode",{parentName:"p"},"NaN"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"Infinity")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"-Infinity"),". The old version of Dark generates them as\nbare identifiers, while the new version puts them in a string (e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"NaN")," vs\n",(0,i.kt)("inlineCode",{parentName:"p"},'"NaN"'),")."),(0,i.kt)("p",null,"This may occur in any of the places in which we generate JSON, which are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"when responding to a HTTP request in the HTTP framework"),(0,i.kt)("li",{parentName:"ul"},"when making a request with ",(0,i.kt)("inlineCode",{parentName:"li"},"HttpClient")," (any version)"),(0,i.kt)("li",{parentName:"ul"},"when calling any of:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Dict::toJson_v0")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Object::toJson_v1")," (",(0,i.kt)("em",{parentName:"li"},"deprecated"),")"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Object::toJson_v0")," (",(0,i.kt)("em",{parentName:"li"},"deprecated"),")"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Twilio::sendText_v1")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Twilio::sendText_v0")," (",(0,i.kt)("em",{parentName:"li"},"deprecated"),")")))),(0,i.kt)("p",null,"Note that the following ",(0,i.kt)("inlineCode",{parentName:"p"},"JWT")," functions do not use this new behavior, and should\nhave the exact same behavior as before, including:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"JWT::signAndEncode_v0")," (",(0,i.kt)("em",{parentName:"li"},"deprecated"),")"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"JWT::signAndEncode_v1")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"JWT::signAndEncodeWithHeaders_v0")," (",(0,i.kt)("em",{parentName:"li"},"deprecated"),")"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"JWT::signAndEncodeWithHeaders_v1"))),(0,i.kt)("h3",{id:"parsing-json"},"Parsing JSON"),(0,i.kt)("p",null,"When parsing JSON, we no longer accept the following invalid JSON:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"bare field names, such as in ",(0,i.kt)("inlineCode",{parentName:"li"},"{ id : 5 }"),". You need to quote field names:\n",(0,i.kt)("inlineCode",{parentName:"li"},'{ "id": 5 }')),(0,i.kt)("li",{parentName:"ul"},"newlines and invalid bytes in JSON strings"),(0,i.kt)("li",{parentName:"ul"},"the bare identifiers ",(0,i.kt)("inlineCode",{parentName:"li"},"NaN"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"Infinity")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"-Infinity")," are no longer parsed\ninto valid floats (note that the old version of Dark might have generated JSON\nwith these values in it)")),(0,i.kt)("p",null,"Dark now also allows parsing 64-bit integers (as opposed to 63-bit integers\nbefore)."),(0,i.kt)("p",null,"Dark parses JSON:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"when receiving a HTTP request in the HTTP framework")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"when receiving a response to a request made with ",(0,i.kt)("inlineCode",{parentName:"p"},"HttpClient")," (any version)")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"when calling any of:"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"JSON::parse_v1")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"JSON::parse_v0")," (",(0,i.kt)("em",{parentName:"li"},"deprecated"),")"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"JSON::read_v0")," (",(0,i.kt)("em",{parentName:"li"},"deprecated"),")"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"JSON::read_v0")," (",(0,i.kt)("em",{parentName:"li"},"deprecated"),")")))),(0,i.kt)("p",null,"Note that ",(0,i.kt)("inlineCode",{parentName:"p"},"JWT::verifyAndExtract_v0")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"JWT::verifyAndExtract_v1")," are not\naffected by this change, as they have been kept deliberately compatible with the\nold versions."),(0,i.kt)("h3",{id:"http-stack"},"HTTP stack"),(0,i.kt)("p",null,"Dark has switched to using Kestrel, a high-performance HTTP server from .NET,\nfor its HTTP server. There are some differences between the new Kestrel-based\nserver and the previous OCaml ",(0,i.kt)("inlineCode",{parentName:"p"},"cohttp"),"-based server:"),(0,i.kt)("p",null,"Large differences:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Dark programs can no longer set the HTTP ",(0,i.kt)("inlineCode",{parentName:"p"},"Content-Length")," header and it will\nbe set automatically. A ",(0,i.kt)("inlineCode",{parentName:"p"},"Content-Length")," header will be ignored if provided\nvia ",(0,i.kt)("inlineCode",{parentName:"p"},"Http::response")," or similar functions.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Dark is now less lenient to receiving incorrect ",(0,i.kt)("inlineCode",{parentName:"p"},"Content-Length")," headers. If\nthe data sent does not match the expected ",(0,i.kt)("inlineCode",{parentName:"p"},"Content-Length"),", the HTTP server\nwill return a 400 Bad Request error. Omitting the ",(0,i.kt)("inlineCode",{parentName:"p"},"Content-Length")," header is\nstill OK.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"JSON returned from HTTP requests is now formatted differently, as discussed\nabove."))),(0,i.kt)("p",null,"Minor differences:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"When making HTTP requests to Dark:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Clients must send at least 256 bytes every 5 seconds or be timed-out"),(0,i.kt)("li",{parentName:"ul"},"All headers must be sent in first 10 seconds"),(0,i.kt)("li",{parentName:"ul"},"There must be fewer than 100 headers and they must fit in 32KB"),(0,i.kt)("li",{parentName:"ul"},"The maximum size of HTTP requests to Dark is 10MB"))),(0,i.kt)("li",{parentName:"ul"},"HTTP responses sent by Dark",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Headers will be returned in a different order"),(0,i.kt)("li",{parentName:"ul"},"Headers are not always lowercase anymore"),(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"Date")," header is now always present"),(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"Server")," header is now ",(0,i.kt)("inlineCode",{parentName:"li"},"darklang")," and always present")))),(0,i.kt)("h2",{id:"testing-changes"},"Testing changes"),(0,i.kt)("p",null,"We have gone from about 250 backend tests to over 5,000. We now have custom test\nframeworks for:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/darklang/dark/tree/main/backend/testfiles/execution"},"language and standard library testing"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/darklang/dark/tree/main/backend/testfiles/httphandler"},"HTTP server testing"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/darklang/dark/tree/main/backend/testfiles/httpclient"},"Testing HTTP clients"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/darklang/stable-dark/tree/main/backend/tests/FuzzTests"},"Fuzz testing"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("a",{parentName:"p",href:"https://github.com/darklang/stable-dark/tree/main/integration-tests"},"Integration tests"),"\nwere ported to ",(0,i.kt)("a",{parentName:"p",href:"https://playwright.dev/"},"Playwright"),", from TestCafe. They now\nrun much faster and are somewhat easier to write."))),(0,i.kt)("h2",{id:"operational-changes"},"Operational changes"),(0,i.kt)("p",null,"Behind the scenes, Dark has greatly improved its operations."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Switched to massively more powerful servers (requests now get 2 CPUs of a\n",(0,i.kt)("a",{parentName:"p",href:"https://cloud.google.com/blog/products/compute/compute-engine-tau-t2d-vms-now-available-for-scale-out-workloads"},"Google Cloud T2D"),",\nvs 0.1 CPUs of a n1d -- T2Ds are about 2.3x more powerful than N1Ds)")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Separated the servers used by the Darklang editor from the ones running\nproduction applications.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Massively increased use of ",(0,i.kt)("a",{parentName:"p",href:"https://honeycomb.io"},"observability")," and error\ntracking to catch errors and customer issues")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Moved queues from running in the database (often taking over 50% of the CPU,\nto relying on our cloud vendor (Google PubSub). Also greatly increased\nreliability of the queues.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Nodes are now autoscaled, leading to significant cost savings.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Updated to latest version of Kubernetes, ",(0,i.kt)("inlineCode",{parentName:"p"},"cert-manager")," (which powers our\n",(0,i.kt)("a",{parentName:"p",href:"https://docs.darklang.com/how-to/custom-domains"},"custom domains")," feature),\nnginx, and other tools that we use.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Added internal ",(0,i.kt)("a",{parentName:"p",href:"https://launchdarkly.com"},"feature flagging")," to give us more\ncontrol over how our infrastructure runs in production")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Significantly increased use of Kubernetes' security features, in particular\ninternal firewalls.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Standardized our production deployment process using a tool we wrote called\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/darklang/dark/blob/8082df91676de2f26a0661bf20827a60976bb3c0/scripts/deployment/shipit"},"shipit"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Removed nginx from our builtwithdark.com backends")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Move migrations out from startup code")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"All certs except darksa.com and darkstaticassets.com are now managed\nautomatically"))),(0,i.kt)("h2",{id:"documentation-changes"},"Documentation changes"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"moved docs to docs.darklang.com"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/darklang/docs/pull/220"},"refactored docs")," to use the Divio\ndocumentation system, categorizing all docs into Tutorials, Reference,\nHow-tos, Walk-throughs and Discussion."),(0,i.kt)("li",{parentName:"ul"},"fixed all links"),(0,i.kt)("li",{parentName:"ul"},"redo the\n",(0,i.kt)("a",{parentName:"li",href:"https://docs.darklang.com/discussion/error-handling"},"Error Rail discussion")),(0,i.kt)("li",{parentName:"ul"},"add a discussion of\n",(0,i.kt)("a",{parentName:"li",href:"https://docs.darklang.com/discussion/queues"},"how the Queues work")),(0,i.kt)("li",{parentName:"ul"},"improved and expanded\n",(0,i.kt)("a",{parentName:"li",href:"https://docs.darklang.com/reference/keyboard-mapping"},"keyboard shortcuts docs"))),(0,i.kt)("h2",{id:"contributing-changes"},"Contributing changes"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Added\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/darklang/dark/blob/main/CODING-GUIDE.md"},"coding guidelines"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Added significant documentation, especially READMEs and design decisions,\nthroughout the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/darklang/dark"},"darklang repo"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Moved 99% of project collaboration to our\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/darklang/dark"},"public GitHub")," and\n",(0,i.kt)("a",{parentName:"p",href:"https://darklang.com/discord-invite"},"public community chat"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"ported our\n",(0,i.kt)("a",{parentName:"p",href:"https://docs.darklang.com/contributing/rescript-and-fsharp-for-dark-developers"},"contributor guides"),"\nto F#"))))}c.isMDXComponent=!0}}]);