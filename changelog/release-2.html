<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-changelog/release-2">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Darklang Release 2 | Dark Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.darklang.com/img/favicon.ico"><meta data-rh="true" name="twitter:image" content="https://docs.darklang.com/img/favicon.ico"><meta data-rh="true" property="og:url" content="https://docs.darklang.com/changelog/release-2"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Darklang Release 2 | Dark Documentation"><meta data-rh="true" name="description" content="June 6th, 2022"><meta data-rh="true" property="og:description" content="June 6th, 2022"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.darklang.com/changelog/release-2"><link data-rh="true" rel="alternate" href="https://docs.darklang.com/changelog/release-2" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.darklang.com/changelog/release-2" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://QFOZBC0VVL-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-159199190-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<link rel="search" type="application/opensearchdescription+xml" title="Dark Documentation" href="/opensearch.xml">
<link rel="preconnect" href="https://cdn.heapanalytics.com">
<link rel="dns-prefetch" href="https://cdn.heapanalytics.com">
<script>window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=document.createElement("script");r.type="text/javascript",r.async=!0,r.src="https://cdn.heapanalytics.com/js/heap-"+e+".js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(r,a);for(var n=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","resetIdentity","removeEventProperty","setEventProperties","track","unsetEventProperty"],o=0;o<p.length;o++)heap[p[o]]=n(p[o])},heap.load(477722926)</script>
<link rel="preconnect" href="https://cdn.heysavvy.com">
<link rel="dns-prefetch" href="https://cdn.heysavvy.com"><link rel="stylesheet" href="/assets/css/styles.d65cafe2.css">
<link rel="preload" href="/assets/js/runtime~main.142977dd.js" as="script">
<link rel="preload" href="/assets/js/main.509985b2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://darklang.com" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/favicon.ico" alt="Darklang logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/favicon.ico" alt="Darklang logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Darklang</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/introduction">Documentation</a><a class="navbar__item navbar__link" href="/tutorials/first-dark-application">Tutorial</a><a class="navbar__item navbar__link" href="/contributing/getting-started">Contributing</a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/introduction">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/tutorial">Tutorial</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tutorial&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/walk-throughs">Walk-throughs</a><button aria-label="Toggle the collapsible sidebar category &#x27;Walk-throughs&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/how-to">How-to Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;How-to Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/discussion">Discussion</a><button aria-label="Toggle the collapsible sidebar category &#x27;Discussion&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/changelog">Changelog</a><button aria-label="Toggle the collapsible sidebar category &#x27;Changelog&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/changelog/release-8">Release 8 - Dec 1, 2022</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/changelog/release-7">Release 7 - Nov 1, 2022</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/changelog/release-6">Release 6 - Oct 1, 2022</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/changelog/release-5">Release 5 - Sept 1, 2022</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/changelog/release-4">Release 4 - Aug 1, 2022</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/changelog/release-3">Release 3 - July 1, 2022</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/changelog/release-2">Release 2 - June 6, 2022</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/changelog/release-1">Release 1</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/reference">Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/changelog"><span itemprop="name">Changelog</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Release 2 - June 6, 2022</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1 id="darklang-release-2">Darklang Release 2</h1><p>June 6th, 2022</p><p>Darklang Release 2 is the culmination of 20 months work of rewriting the backend
from OCaml to F#. This was done to give us more productivity by allowing us use
more 3rd party SDKs, to solve operational issues, and to make it easier to
contribute. Our reasons for making the change were discussed at the time:
<a href="https://blog.darklang.com/new-backend-fsharp/">1</a>,
<a href="https://blog.darklang.com/why-dark-didnt-choose-rust/">2</a>,
<a href="https://blog.darklang.com/leaving-ocaml/">3</a>.</p><ul><li>The editor backend was fully migrated by April 2nd.</li><li>HTTP backends (for builtwithdark.com) were finished converting on May 3rd.</li><li>The migration to the new queues was fully converted on May 27th.</li><li>The execution engine in the editor was switched over on June 5th.</li></ul><p>The change was documented in a series of blog posts:
<a href="https://blog.darklang.com/hows-the-dark-rewrite-going/">1</a>,
<a href="https://blog.darklang.com/changes-the-the-dark-rewrite/">2</a>,
<a href="https://blog.darklang.com/optimizing-tasks-in-fsharp/">3</a>,
<a href="https://blog.darklang.com/benchmarking-fsharp6-tasks/">4</a>,
<a href="https://blog.darklang.com/darklang-year-in-review-2021/">5</a>,
<a href="https://blog.darklang.com/try-out-the-new-darklang-backend/">6</a>, and
<a href="https://blog.darklang.com/backend-rewrite-complete/">7</a>.</p><p>Thanks to everyone who contributed, including
<a href="https://github.com/Athinanarof">Araceli Sánchez</a>,
<a href="https://github.com/levlaz">Lev Lazinskiy</a>,
<a href="https://github.com/mariajdab">María José Dávila</a>,
<a href="https://github.com/mjeffryes">Matthew Jeffryes</a>,
<a href="https://github.com/jwalter">jwalter</a>,
<a href="https://github.com/danicampagna">Daniela Campagna</a>,
<a href="https://github.com/sxmanton">Sean Manton</a>, and especially
<a href="https://github.com/stachudotnet">Stachu Korick</a>.</p><h2 id="major-changes">Major changes</h2><ul><li><p>Darklang&#x27;s implementation is now asynchronous, meaning that your programs will
no longer be stuck behind other users&#x27; programs making HTTP or DB calls. This
was a major source of slow Dark programs experienced by most users.</p><p>As well as massively reducing latency for programs written in Dark, the editor
now loads much faster.</p><p>We have also switched from dozens of tiny machines to a smaller number of much
more powerful machines. This makes your programs run faster on average, even
when accounting for the switch to an asynchronous implementation.</p></li><li><p>You can now put a lambda in a variable and pipe into it.</p></li><li><p>Most error messages are improved, especially for bad input.</p></li><li><p>The queues have been rewritten and should not longer suffer from the old
sources of occasional downtime and slow-down.</p></li><li><p>During a deploy of the Dark service, cron jobs no longer run the risk of
running twice.</p></li><li><p>There is now a <a href="https://status.darklang.com">Status page</a>.</p></li><li><p>Dark&#x27;s internal firewalls have been significantly improved</p></li><li><p>Several bottlenecks to outbound HTTP requests have been identified and removed</p></li><li><p><code>String::length</code> is now <code>O(1)</code> instead of <code>O(N)</code></p></li><li><p>JSON output is now significantly faster</p></li><li><p>When reading strings from a user, the string is only passed over once.</p></li><li><p>Traces are now stored in the background, after a request has completed,
greatly reducing response time on HTTP requests to Dark programs.</p></li><li><p>Dark has moved to more powerful cloud machines, going from Google&#x27; Cloud&#x27;s
deprecated N1 machines to extremely powerful T2D machines (2.3x faster)</p></li><li><p>The rewrite also addressed some underlying issues that will come out in new
features soon, including a better type system, support for characters and
tuples, fixes for poor behavior in Date and String functions, and more. These
issues are tracked in our new
<a href="https://github.com/darklang/dark/projects/1#column-15173588">project tracker</a>.</p></li></ul><h3 id="error-messages">Error messages</h3><p>All error messages have been renovated, attempting to make them more consistent
and to reuse error message machinery. As a result, a majority of Dark error
messages have changed. If you were relying on the explicit format of a Dark
language or StdLib error message, expect that it will be different.</p><p>If you do any error handling which relies specifically on the text of an error
message coming from Dark, we recommend you no longer do that, and just use the
presence of the error instead of the text.</p><p>There are two places in Dark which use string error messages:</p><h4 id="resulterrors"><code>Result.Error</code>s</h4><p>The <code>Error</code> enum (referred to as <code>Result.Error</code> below for clarity), will contain
a string error in most cases, which you might be using directly or indirectly.</p><p>You might be accessing <code>Result.Error</code>s and their text contents directly using
the <code>match</code> statement.</p><p>You might also be accessing their text contents indirectly, using <code>toString</code>, or
other stringifying functions, such as <code>toString</code>, <code>JSON::</code> functions and
<code>HTTPClient::</code> functions. This is only true if you taken the function returning
the <code>Result.Error</code> off the error rail. This text may also make it to your
web/mobile clients or API consumers.</p><p><code>Result.Error</code>s returned via a HTTP handler are not presented to the user, so
text cannot leak that way.</p><h4 id="runtime-errors">Runtime errors</h4><p>Runtime errors (including type errors) are not accessible via Dark programs, and
will always terminate the Dark program when they are accessed. As a result, the
text of any runtime error should not be accessible to your programs or your
users.</p><h2 id="minor-improvements-and-fixes">Minor improvements and fixes</h2><ul><li><p>Dark used to return the <code>Access-Control-Allow-Origin</code> header in lower-case, it
is now returned in mixed case.</p></li><li><p>When making a web request to your Dark application, if you did not specific a
<code>user-agent</code> header, Dark used to add a <code>user-agent</code> header of
<code>ocaml-cohttp/1.2.0</code>. We no longer add this header.</p></li><li><p>When making a web request to your Dark application with a <code>content-type</code>
header of <code>text/ping</code>, Dark used to ignore the code and immediately return a
response of status code 418. It now processes the request instead.</p></li><li><p><code>HttpClient::*</code> functions called with usernames and passwords in the URL can
now support arbitrary UTF-8 (in the past, Unicode was not supported.)</p></li><li><p><code>X509::pemCertificatePublicKeys</code> used to only work for RSA keys. It now also
supports DSA and ECDSA keys. The old version would read ECDSA keys and return
an incorrect answer - it now returns a correct answer.</p></li><li><p><code>String::split</code> would fail if the 2nd argument was <code>&quot;&quot;</code> and the first argument
was a complex Unicode character, such as <code>String::split &quot;👨‍❤️‍💋‍👨👩‍👩‍👧‍👦🏳️‍⚧️‍️🇵🇷&quot; &quot;&quot;</code>. This
is now split correctly.</p></li><li><p><code>String.trim</code>, <code>String::trimEnd</code> and <code>String::trimStart</code> worked incorrectly in
some Unicode situations, they now work correctly.</p></li></ul><h2 id="breaking-changes">Breaking changes</h2><p>These breaking changes were documented and announced many months in advance of
switching over to the new version of Darklang. We also very careful deployed the
new code, watching for suspicious changes in any Dark programs that were
running. In the rare case where something went awry, we contacted the users and
worked with them to ensure a seamless transition.</p><h3 id="string-casing">String casing</h3><ul><li><code>String::toLowercase_v0</code> and <code>String::toUppercase_v0</code> worked correctly in the
old version of Dark, for all unicode. In the new version, the library we are
using does not correctly handle some case changes, instead keeping the
original character. This happens when the replacement is a different length
than the character being replaced (for example, <code>&quot;և&quot;</code> should be <code>&quot;ԵՒ&quot;</code> when
converted to upper case, which the old version did correctly and the new
version does not). We plan to fix this at a later point.</li></ul><h3 id="string-ordering">String ordering</h3><ul><li><p>Functions whose output relies on the internal ordering of a <code>Dict</code> may have
different outputs, specifically, the output Lists may be in a different order.
Examples include <code>Dict::keys</code>, <code>Dict::values</code>, and <code>Dict::toList</code> which return
<code>List</code>s of values which are ordered based on the internal ordering in the
original <code>Dict</code>.</p></li><li><p>When calling <code>List::uniqueBy</code>, and there is a duplicate, the new version of
Dark may pick a different value for the duplicate. For example:</p></li></ul><pre><code class="language-dark">List.uniqueBy_v0 [1;2;3;4] (fun x -&gt; Int.divide_v0 x 2) = [ 1, 3, 4 ] // old Dark
List.uniqueBy_v0 [1;2;3;4] (fun x -&gt; Int.divide_v0 x 2) = [ 1, 2, 4 ] // new Dark
</code></pre><h3 id="http-clients">HTTP Clients</h3><ul><li><code>HttpClient::*</code> functions no longer support making requests with arbitrary
<code>Content-Type</code>s. They must now be
<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type">valid</a>,
for example <code>&quot;application/json&quot;</code> or <code>&quot;application/json; charset=utf-8&quot;</code>.</li></ul><h3 id="generating-json">Generating JSON</h3><p>We have changed how JSON is generated in many cases. All the JSON generated by
Dark is now standards compliant, and uses a different formatting style.</p><p>In the old version of Dark, we would generate invalid JSON for the Float values
<code>NaN</code>, <code>Infinity</code> and <code>-Infinity</code>. The old version of Dark generates them as
bare identifiers, while the new version puts them in a string (e.g. <code>NaN</code> vs
<code>&quot;NaN&quot;</code>).</p><p>This may occur in any of the places in which we generate JSON, which are:</p><ul><li>when responding to a HTTP request in the HTTP framework</li><li>when making a request with <code>HttpClient</code> (any version)</li><li>when calling any of:<ul><li><code>Dict::toJson_v0</code></li><li><code>Object::toJson_v1</code> (<em>deprecated</em>)</li><li><code>Object::toJson_v0</code> (<em>deprecated</em>)</li><li><code>Twilio::sendText_v1</code></li><li><code>Twilio::sendText_v0</code> (<em>deprecated</em>)</li></ul></li></ul><p>Note that the following <code>JWT</code> functions do not use this new behavior, and should
have the exact same behavior as before, including:</p><ul><li><code>JWT::signAndEncode_v0</code> (<em>deprecated</em>)</li><li><code>JWT::signAndEncode_v1</code></li><li><code>JWT::signAndEncodeWithHeaders_v0</code> (<em>deprecated</em>)</li><li><code>JWT::signAndEncodeWithHeaders_v1</code></li></ul><h3 id="parsing-json">Parsing JSON</h3><p>When parsing JSON, we no longer accept the following invalid JSON:</p><ul><li>bare field names, such as in <code>{ id : 5 }</code>. You need to quote field names:
<code>{ &quot;id&quot;: 5 }</code></li><li>newlines and invalid bytes in JSON strings</li><li>the bare identifiers <code>NaN</code>, <code>Infinity</code> and <code>-Infinity</code> are no longer parsed
into valid floats (note that the old version of Dark might have generated JSON
with these values in it)</li></ul><p>Dark now also allows parsing 64-bit integers (as opposed to 63-bit integers
before).</p><p>Dark parses JSON:</p><ul><li><p>when receiving a HTTP request in the HTTP framework</p></li><li><p>when receiving a response to a request made with <code>HttpClient</code> (any version)</p></li><li><p>when calling any of:</p><ul><li><code>JSON::parse_v1</code></li><li><code>JSON::parse_v0</code> (<em>deprecated</em>)</li><li><code>JSON::read_v0</code> (<em>deprecated</em>)</li><li><code>JSON::read_v0</code> (<em>deprecated</em>)</li></ul></li></ul><p>Note that <code>JWT::verifyAndExtract_v0</code> and <code>JWT::verifyAndExtract_v1</code> are not
affected by this change, as they have been kept deliberately compatible with the
old versions.</p><h3 id="http-stack">HTTP stack</h3><p>Dark has switched to using Kestrel, a high-performance HTTP server from .NET,
for its HTTP server. There are some differences between the new Kestrel-based
server and the previous OCaml <code>cohttp</code>-based server:</p><p>Large differences:</p><ul><li><p>Dark programs can no longer set the HTTP <code>Content-Length</code> header and it will
be set automatically. A <code>Content-Length</code> header will be ignored if provided
via <code>Http::response</code> or similar functions.</p></li><li><p>Dark is now less lenient to receiving incorrect <code>Content-Length</code> headers. If
the data sent does not match the expected <code>Content-Length</code>, the HTTP server
will return a 400 Bad Request error. Omitting the <code>Content-Length</code> header is
still OK.</p></li><li><p>JSON returned from HTTP requests is now formatted differently, as discussed
above.</p></li></ul><p>Minor differences:</p><ul><li>When making HTTP requests to Dark:<ul><li>Clients must send at least 256 bytes every 5 seconds or be timed-out</li><li>All headers must be sent in first 10 seconds</li><li>There must be fewer than 100 headers and they must fit in 32KB</li><li>The maximum size of HTTP requests to Dark is 10MB</li></ul></li><li>HTTP responses sent by Dark<ul><li>Headers will be returned in a different order</li><li>Headers are not always lowercase anymore</li><li>The <code>Date</code> header is now always present</li><li>The <code>Server</code> header is now <code>darklang</code> and always present</li></ul></li></ul><h2 id="testing-changes">Testing changes</h2><p>We have gone from about 250 backend tests to over 5,000. We now have custom test
frameworks for:</p><ul><li><p><a href="https://github.com/darklang/dark/tree/main/backend/testfiles/execution">language and standard library testing</a></p></li><li><p><a href="https://github.com/darklang/dark/tree/main/backend/testfiles/httphandler">HTTP server testing</a></p></li><li><p><a href="https://github.com/darklang/dark/tree/main/backend/testfiles/httpclient">Testing HTTP clients</a></p></li><li><p><a href="https://github.com/darklang/dark/tree/main/backend/tests/FuzzTests">Fuzz testing</a></p></li><li><p><a href="https://github.com/darklang/dark/tree/main/integration-tests">Integration tests</a>
were ported to <a href="https://playwright.dev/">Playwright</a>, from TestCafe. They now
run much faster and are somewhat easier to write.</p></li></ul><h2 id="operational-changes">Operational changes</h2><p>Behind the scenes, Dark has greatly improved its operations.</p><ul><li><p>Switched to massively more powerful servers (requests now get 2 CPUs of a
<a href="https://cloud.google.com/blog/products/compute/compute-engine-tau-t2d-vms-now-available-for-scale-out-workloads">Google Cloud T2D</a>,
vs 0.1 CPUs of a n1d -- T2Ds are about 2.3x more powerful than N1Ds)</p></li><li><p>Separated the servers used by the Darklang editor from the ones running
production applications.</p></li><li><p>Massively increased use of <a href="https://honeycomb.io">observability</a> and error
tracking to catch errors and customer issues</p></li><li><p>Moved queues from running in the database (often taking over 50% of the CPU,
to relying on our cloud vendor (Google PubSub). Also greatly increased
reliability of the queues.</p></li><li><p>Nodes are now autoscaled, leading to significant cost savings.</p></li><li><p>Updated to latest version of Kubernetes, <code>cert-manager</code> (which powers our
<a href="https://docs.darklang.com/how-to/custom-domains">custom domains</a> feature),
nginx, and other tools that we use.</p></li><li><p>Added internal <a href="https://launchdarkly.com">feature flagging</a> to give us more
control over how our infrastructure runs in production</p></li><li><p>Significantly increased use of Kubernetes&#x27; security features, in particular
internal firewalls.</p></li><li><p>Standardized our production deployment process using a tool we wrote called
<a href="https://github.com/darklang/dark/blob/8082df91676de2f26a0661bf20827a60976bb3c0/scripts/deployment/shipit">shipit</a></p></li><li><p>Removed nginx from our builtwithdark.com backends</p></li><li><p>Move migrations out from startup code</p></li><li><p>All certs except darksa.com and darkstaticassets.com are now managed
automatically</p></li></ul><h2 id="documentation-changes">Documentation changes</h2><ul><li>moved docs to docs.darklang.com</li><li><a href="https://github.com/darklang/docs/pull/220">refactored docs</a> to use the Divio
documentation system, categorizing all docs into Tutorials, Reference,
How-tos, Walk-throughs and Discussion.</li><li>fixed all links</li><li>redo the
<a href="https://docs.darklang.com/discussion/error-handling">Error Rail discussion</a></li><li>add a discussion of
<a href="https://docs.darklang.com/discussion/queues">how the Queues work</a></li><li>improved and expanded
<a href="https://docs.darklang.com/reference/keyboard-mapping">keyboard shortcuts docs</a></li></ul><h2 id="contributing-changes">Contributing changes</h2><ul><li><p>Added
<a href="https://github.com/darklang/dark/blob/main/CODING-GUIDE.md">coding guidelines</a></p></li><li><p>Added significant documentation, especially READMEs and design decisions,
throughout the <a href="https://github.com/darklang/dark">darklang repo</a></p></li><li><p>Moved 99% of project collaboration to our
<a href="https://github.com/darklang/dark">public GitHub</a> and
<a href="https://darklang.com/discord-invite">public community chat</a></p></li><li><p>ported our
<a href="https://docs.darklang.com/contributing/rescript-and-fsharp-for-dark-developers">contributor guides</a>
to F#</p></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/darklang/docs/edit/main/docs/changelog/release-2.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/changelog/release-3"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Darklang Release 3</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/changelog/release-1"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Darklang Release 1</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#major-changes" class="table-of-contents__link toc-highlight">Major changes</a><ul><li><a href="#error-messages" class="table-of-contents__link toc-highlight">Error messages</a></li></ul></li><li><a href="#minor-improvements-and-fixes" class="table-of-contents__link toc-highlight">Minor improvements and fixes</a></li><li><a href="#breaking-changes" class="table-of-contents__link toc-highlight">Breaking changes</a><ul><li><a href="#string-casing" class="table-of-contents__link toc-highlight">String casing</a></li><li><a href="#string-ordering" class="table-of-contents__link toc-highlight">String ordering</a></li><li><a href="#http-clients" class="table-of-contents__link toc-highlight">HTTP Clients</a></li><li><a href="#generating-json" class="table-of-contents__link toc-highlight">Generating JSON</a></li><li><a href="#parsing-json" class="table-of-contents__link toc-highlight">Parsing JSON</a></li><li><a href="#http-stack" class="table-of-contents__link toc-highlight">HTTP stack</a></li></ul></li><li><a href="#testing-changes" class="table-of-contents__link toc-highlight">Testing changes</a></li><li><a href="#operational-changes" class="table-of-contents__link toc-highlight">Operational changes</a></li><li><a href="#documentation-changes" class="table-of-contents__link toc-highlight">Documentation changes</a></li><li><a href="#contributing-changes" class="table-of-contents__link toc-highlight">Contributing changes</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learning</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://darklang.com/launch/demo-video" target="_blank" rel="noopener noreferrer" class="footer__link-item">Demo Video</a></li><li class="footer__item"><a href="https://youtube.com/c/Darklang/videos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Tutorial Videos</a></li><li class="footer__item"><a href="https://darklang.com/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/tutorials/first-dark-application">Tutorial</a></li><li class="footer__item"><a class="footer__link-item" href="/category/walk-throughs">Walk-throughs</a></li></ul></div><div class="col footer__col"><div class="footer__title">About</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://darklang.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Company</a></li><li class="footer__item"><a href="https://blog.darklang.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://darklang.com/discord-invite" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community Discord</a></li><li class="footer__item"><a href="https://github.com/darklang/dark" target="_blank" rel="noopener noreferrer" class="footer__link-item">Dark Repo</a></li><li class="footer__item"><a href="https://github.com/darklang/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Docs Repo</a></li><li class="footer__item"><a class="footer__link-item" href="/contributing/getting-started">Contributor Docs</a></li><li class="footer__item"><a href="https://darklang.com/code-of-conduct" target="_blank" rel="noopener noreferrer" class="footer__link-item">Code of Conduct</a></li></ul></div><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://darklang.com/login" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sign in</a></li><li class="footer__item"><a href="https://darklang.com/signup" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sign up</a></li><li class="footer__item"><a href="https://darklang.com/desktop-client" target="_blank" rel="noopener noreferrer" class="footer__link-item">Desktop Client</a></li><li class="footer__item"><a href="https://darklang.com/mailing-list" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mailing List</a></li><li class="footer__item"><a class="footer__link-item" href="/reference/changelog">Changelog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Dark Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.142977dd.js"></script>
<script src="/assets/js/main.509985b2.js"></script>
<script async="true" defer="true" src="https://cdn.heysavvy.com/wc/savvy.min.js"></script>
        <savvy-smart-form id="6HBmUjmI12nCuopyvB0B"></savvy-smart-form></body>
</html>